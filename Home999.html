<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡πÄ‡∏Å‡∏©‡∏ï‡∏£ Now + AI</title>

  <!-- Leaflet ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#fff;
      --text:#1f2937;
      --muted:#6b7280;
      --brand:#10b981;
      --brand2:#3b82f6;
      --radius:18px;
      --shadow:0 8px 24px rgba(0,0,0,.06)
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:ui-rounded,"Segoe UI",system-ui,-apple-system,"Kanit",sans-serif
    }
    header.appbar{
      position:sticky;
      top:0;
      background:rgba(245,247,251,.8);
      backdrop-filter:blur(8px);
      border-bottom:1px solid #eee;
      z-index:20
    }
    .wrap{max-width:1100px;margin:0 auto;padding:14px 20px}
    .hello{
      display:inline-flex;
      align-items:center;
      gap:10px;
      background:var(--card);
      padding:8px 12px;
      border-radius:999px;
      box-shadow:var(--shadow);
      border:1px solid #eee;
      font-weight:600
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      background:#f1f5f9;
      border-radius:999px;
      font-size:12px
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:20px;
      max-width:1100px;
      margin:0 auto;
      padding:16px 20px 86px
    }
    .card{
      grid-column:span 4;
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px 16px;
      border:1px solid #eee
    }
    .big{grid-column:span 8}
    @media(max-width:980px){
      .card{grid-column:span 6}
      .big{grid-column:span 12}
    }
    @media(max-width:680px){
      .card{grid-column:span 12}
    }
    .title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      font-size:17px;
      margin-bottom:6px
    }
    .badge{
      margin-left:auto;
      font-size:11px;
      color:#fff;
      background:#16a34a;
      padding:2px 8px;
      border-radius:999px
    }
    .rows{
      display:flex;
      flex-direction:column;
      gap:6px
    }
    .muted{color:var(--muted)}
    .divider{height:1px;background:#eee;margin:10px 0}
    .stack{display:flex;gap:8px;flex-wrap:wrap}
    input,button,select,textarea{
      font:inherit;
      border-radius:12px;
      border:1px solid #e5e7eb;
      padding:8px 10px;
      background:#fff
    }
    button{
      background:var(--brand2);
      color:#fff;
      border:none;
      font-weight:700;
      cursor:pointer
    }
    button.ghost{
      background:#eef2ff;
      color:#374151
    }
    .btn-link{
      background:#eef2ff;
      color:#1f2937;
      border:1px solid #e5e7eb;
      border-radius:999px;
      padding:6px 10px;
      font-weight:600;
      cursor:pointer;
      font-size:12px
    }
    .list{display:flex;flex-direction:column;gap:8px}

    .clamp{display:-webkit-box;-webkit-box-orient:vertical;overflow:hidden}
    .clamp-2{-webkit-line-clamp:2}
    .clamp-6{-webkit-line-clamp:6}

    .tr{
      display:grid;
      grid-template-columns:1.2fr .8fr .9fr;
      gap:8px;
      align-items:center;
      background:#f8fafc;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:8px 10px
    }
    .chip{
      font-size:11px;
      background:#e2e8f0;
      border-radius:999px;
      padding:2px 8px
    }

    .news-wrap{ max-height:520px; overflow:auto; padding-right:4px }
    .news-grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px }
    @media (max-width:980px){ .news-grid{ grid-template-columns:1fr } }
    .news-item{
      background:#f8fafc;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:8px 10px;
      display:flex;
      gap:8px;
      align-items:flex-start
    }
    .news-title{ font-weight:700; font-size:14px }
    .news-desc{ color:#6b7280; font-size:13px }
    .news-controls{ display:flex; gap:8px; justify-content:flex-end; margin-top:8px }
    .news-toolbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:8px }
    .news-summary{ background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; padding:8px 10px; font-size:13px }
    .hl{ background:#fde68a }

    .button-container-bottom {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: space-around;
      gap: 10px;
      background-color: white;
      padding: 8px 0;
      box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }

    .btn-bottom {
      background-color: transparent;
      border: none;
      cursor: pointer;
      flex: 1;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      padding: 0;
      text-decoration: none;
      transition: all 0.3s ease;
      box-shadow: none;
    }

    .btn-bottom img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .btn-bottom:hover { transform: scale(1.05); }
    .btn-bottom:active { transform: scale(0.98); }

    .btn-bottom.home      { background-color:#e74c3c; color:white; }
    .btn-bottom.ai        { background-color:#2ecc71; color:white; }
    .btn-bottom.plant     { background-color:#007bff; color:white; }
    .btn-bottom.menu      { background-color:#ff9900; color:white; }

    .chat-fab{
      position:fixed;
      right:16px;
      bottom:84px;
      width:52px;
      height:52px;
      border-radius:50%;
      background:#22c55e;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:24px;
      box-shadow:0 10px 24px rgba(34,197,94,.35);
      cursor:pointer;
      z-index:30
    }
    .chat-box{
      position:fixed;
      right:16px;
      bottom:150px;
      width:320px;
      height:430px;
      background:#fff;
      border:1px solid #eee;
      border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.15);
      display:none;
      flex-direction:column;
      overflow:hidden;
      z-index:35
    }
    .chat-header{
      background:#eafff2;
      color:#065f46;
      padding:10px 12px;
      font-weight:700;
      font-size:14px
    }
    .chat-body{
      flex:1;
      padding:10px;
      overflow:auto;
      background:linear-gradient(180deg,#f8fafc,#fff);
      font-size:13px
    }
    .message{
      margin:6px 0;
      padding:6px 10px;
      border-radius:12px;
      max-width:85%
    }
    .message.user{
      margin-left:auto;
      background:#22c55e;
      color:#fff;
      border-bottom-right-radius:6px
    }
    .message.ai{
      background:#eef2ff;
      color:#111827;
      border-bottom-left-radius:6px
    }
    .chat-footer{
      display:flex;
      gap:8px;
      padding:8px;
      background:#fff;
      border-top:1px solid #eee
    }
    .chat-footer textarea{
      flex:1;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:8px;
      resize:none;
      font-size:13px
    }

    #map{
      width:100%;
      height:240px;
      margin-top:10px;
      border-radius:14px;
      overflow:hidden;
    }

    /* ===== ‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏∞‡∏ó‡∏±‡∏î‡∏£‡∏±‡∏î: ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏ï‡∏µ‡πâ‡∏¢‡∏•‡∏á + ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô ===== */

    body.compact .card{
      padding:10px 12px;
    }
    body.compact .card.big{
      padding:12px 14px;
    }
    body.compact .rows{
      gap:4px;
    }
    body.compact .grid{
      gap:14px;
      padding-bottom:78px;
    }

    /* ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡∏•‡πÑ‡∏°‡πâ: ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà 2 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏ô‡∏™‡∏∏‡∏î ‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤ */
    body.compact #priceCard .rows > .muted{
      display:none;
    }
    body.compact #priceCard .divider,
    body.compact #priceCard .stack{
      display:none;
    }
    body.compact #priceTable .tr:nth-of-type(n+3){
      display:none;
    }

    /* ‡∏Ç‡πà‡∏≤‡∏ß: ‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ + ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 2 ‡∏Ç‡πà‡∏≤‡∏ß‡∏ö‡∏ô‡∏™‡∏∏‡∏î */
    body.compact #newsCard .news-toolbar,
    body.compact #newsCard #newsControls{
      display:none;
    }
    body.compact #newsCard #newsList .news-item:nth-of-type(n+3){
      display:none;
    }

    /* ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏µ‡πâ‡∏¢‡∏•‡∏á‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏∞‡∏ó‡∏±‡∏î‡∏£‡∏±‡∏î */
    body.compact #map{
      height:190px;
    }

    /* ‡∏™‡∏£‡∏∏‡∏õ AI: ‡πÉ‡∏´‡πâ preview ‡∏™‡∏±‡πâ‡∏ô‡∏•‡∏á‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏∞‡∏ó‡∏±‡∏î‡∏£‡∏±‡∏î */
    body.compact #aiSummary-preview.clamp-6{
      -webkit-line-clamp:4;
    }

    body.compact .tr{
      padding:6px 8px;
    }
    body.compact .news-item{
      padding:6px 8px;
    }
  </style>
</head>
<body>
  <header class="appbar">
    <div class="wrap">
      <div class="hello">
        üëãüèª ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£!
        <span class="pill">
          <span id="clock">--:--</span> ‚Ä¢ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ <span id="today"></span>
        </span>
        <button id="compactBtn" class="btn-link" style="margin-left:12px">‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏∞‡∏ó‡∏±‡∏î‡∏£‡∏±‡∏î</button>
      </div>
    </div>
  </header>

  <main class="grid" id="appContent">
    <!-- ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡∏•‡πÑ‡∏°‡πâ -->
    <section class="card" id="priceCard">
      <div class="title">
        üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡∏•‡πÑ‡∏°‡πâ
        <span class="badge" id="priceBadge">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
      </div>
      <div class="rows">
        <div class="muted">
          ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô: ‡∏ï‡∏•‡∏≤‡∏î‡πÑ‡∏ó (‡∏Ñ‡∏•‡∏≠‡∏á‡∏´‡∏•‡∏ß‡∏á, ‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ) ‚Ä¢ ‡∏ï‡∏•‡∏≤‡∏î‡∏™‡∏µ‡πà‡∏°‡∏∏‡∏°‡πÄ‡∏°‡∏∑‡∏≠‡∏á (‡∏•‡∏≥‡∏•‡∏π‡∏Å‡∏Å‡∏≤, ‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ)<br>
          ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å‡∏Ç‡πà‡∏≤‡∏ß ‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏≠‡∏á
        </div>
        <div id="priceTable" class="list"></div>
      </div>
      <div class="divider"></div>
      <div class="stack">
        <input id="pName" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏≤‡∏á‡∏™‡∏≤‡∏î" />
        <input id="pPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏Å‡∏Å." />
        <button onclick="addPrice()">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
      </div>
    </section>

    <!-- ‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏Å‡∏©‡∏ï‡∏£ -->
    <section class="card" id="newsCard">
      <div class="title">
        üì∞ ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£ (‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‚Ä¢ ‡∏°‡∏±‡∏á‡∏Ñ‡∏∏‡∏î ‚Ä¢ ‡πÄ‡∏á‡∏≤‡∏∞)
      </div>
      <div class="news-toolbar">
        <input id="newsSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏Ç‡πà‡∏≤‡∏ß (‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≤‡∏Ñ‡∏≤, ‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï, ‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)" style="min-width:260px" />
        <span class="muted" id="newsCount">‚Äî</span>
      </div>
      <div id="newsSummary" class="news-summary muted">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏´‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πà‡∏≤‡∏ß</div>
      <div id="newsScroll" class="news-wrap">
        <div id="newsList" class="news-grid">
          <div class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πà‡∏≤‡∏ß‚Ä¶</div>
        </div>
      </div>
      <div id="newsControls" class="news-controls"></div>
    </section>

    <!-- ‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏® + ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà -->
    <section class="card big">
      <div class="title">
        üå§Ô∏è ‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®
        <span class="badge" id="placeBadge">‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‚Ä¶</span>
      </div>
      <div class="rows">
        <div>üå°Ô∏è ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥: <b id="temp">--</b>¬∞C</div>
        <div>‚òÅÔ∏è ‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®: <span id="desc" class="muted">--</span></div>
        <div>üíß ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô: <b id="rh">--</b>%</div>
        <div>‚òî ‡∏ù‡∏ô 3 ‡∏ä‡∏°.: <b id="rain">--</b> ‡∏°‡∏°.</div>
        <div>üåßÔ∏è ‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏ù‡∏ô‡∏≠‡∏µ‡∏Å 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á: <b id="rainNext1h">--</b> ‡∏°‡∏°.</div>
      </div>
      <div class="divider"></div>
      <div id="map"></div>
      <div class="divider"></div>
      <div class="stack" id="tokenRow" style="display:none">
        <input id="hfKey" type="password" placeholder="HF Token (hf_‚Ä¶)" style="min-width:260px" autocomplete="off" />
        <button onclick="aggregateNow()">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏° (‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</button>
        <button class="ghost" onclick="saveKey()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Token (‡∏ã‡πà‡∏≠‡∏ô)</button>
      </div>
    </section>

    <!-- ‡∏™‡∏£‡∏∏‡∏õ‡πÇ‡∏î‡∏¢ AI -->
    <section class="card big">
      <div class="title">
        üß† ‡∏™‡∏£‡∏∏‡∏õ‡πÇ‡∏î‡∏¢ AI (Ling-1T)
        <span class="badge">‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏ô + ‡πÄ‡∏û‡∏≤‡∏∞‡∏õ‡∏•‡∏π‡∏Å</span>
      </div>
      <div id="aiBox" class="list">
        <div class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</div>
      </div>
    </section>
  </main>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ä‡∏ó -->
  <div class="chat-fab" id="chatFab">üí¨</div>
  <div class="chat-box" id="chatBox">
    <div class="chat-header">‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</div>
    <div class="chat-body" id="chatBody">
      <div class="message ai">‡∏â‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ üòä</div>
    </div>
    <div class="chat-footer">
      <textarea id="chatInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..." rows="1"
        onkeypress="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage();}"></textarea>
      <button onclick="sendMessage()">‡∏™‡πà‡∏á</button>
    </div>
  </div>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡πà‡∏≤‡∏á -->
  <div class="button-container-bottom">
    <a href="Home999.html" class="btn-bottom home">
      <img src="60.png" alt="Home">
    </a>
    <a href="shop.html" class="btn-bottom menu">
      <img src="333222.png" alt="‡πÄ‡∏°‡∏ô‡∏π">
    </a>
    <a href="Home.html" class="btn-bottom ai">
      <img src="61.png" alt="AI">
    </a>
    <a href="Home555.html" class="btn-bottom plant">
      <img src="62.png" alt="‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡∏•‡∏π‡∏Å">
    </a>
    <a href="menu.html" class="btn-bottom menu">
      <img src="1000.png" alt="‡πÄ‡∏°‡∏ô‡∏π">
    </a>
  </div>

<script>
/* ===== basic UI ===== */
const $=s=>document.querySelector(s);
const pad=n=>String(n).padStart(2,'0');
function setClock(){
  const d=new Date();
  $('#clock').textContent=`${pad(d.getHours())}:${pad(d.getMinutes())}`;
  $('#today').textContent=d.toLocaleDateString('th-TH',{
    weekday:'long',day:'2-digit',month:'short',year:'numeric'
  });
}
setClock();
setInterval(setClock,30_000);

function codeToDesc(c){
  const m={
    0:'‡∏ó‡πâ‡∏≠‡∏á‡∏ü‡πâ‡∏≤‡πÉ‡∏™',1:'‡∏°‡∏µ‡πÄ‡∏°‡∏Ü‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô',2:'‡∏Ñ‡∏£‡∏∂‡πâ‡∏°',3:'‡πÄ‡∏°‡∏Ü‡∏°‡∏≤‡∏Å',
    45:'‡∏´‡∏°‡∏≠‡∏Å',51:'‡∏ù‡∏ô‡∏õ‡∏£‡∏≠‡∏¢',61:'‡∏ù‡∏ô‡πÄ‡∏ö‡∏≤',63:'‡∏ù‡∏ô‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á',
    65:'‡∏ù‡∏ô‡∏´‡∏ô‡∏±‡∏Å',95:'‡∏û‡∏≤‡∏¢‡∏∏‡∏ù‡∏ô‡∏ü‡πâ‡∏≤‡∏Ñ‡∏∞‡∏ô‡∏≠‡∏á'
  };
  return m[c]||'‡πÅ‡∏õ‡∏£‡∏õ‡∏£‡∏ß‡∏ô';
}
function seasonTH(m){
  return (m>=5&&m<=10)?'‡∏ù‡∏ô':(m===3||m===4)?'‡∏£‡πâ‡∏≠‡∏ô':'‡∏´‡∏ô‡∏≤‡∏ß';
}
function setLoading(on){
  document.querySelectorAll('button').forEach(b=>b.disabled=!!on);
  if(on) $('#aiBox').innerHTML='<div>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</div>';
}

const USE_HF = false; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô true ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å HF ‡∏à‡∏£‡∏¥‡∏á

/* ===== compact mode (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏∞‡∏ó‡∏±‡∏î‡∏£‡∏±‡∏î) ===== */
(function(){
  let saved = localStorage.getItem('COMPACT_MODE');
  let on = saved ? (saved === '1') : true; // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏ã‡∏ü -> ‡∏Å‡∏∞‡∏ó‡∏±‡∏î‡∏£‡∏±‡∏î

  document.body.classList.toggle('compact', on);

  const btn = $('#compactBtn');
  if(btn){
    btn.textContent = on ? '‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥' : '‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏∞‡∏ó‡∏±‡∏î‡∏£‡∏±‡∏î';
    btn.onclick = () => {
      on = !on;
      document.body.classList.toggle('compact', on);
      localStorage.setItem('COMPACT_MODE', on ? '1' : '0');
      btn.textContent = on ? '‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥' : '‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏∞‡∏ó‡∏±‡∏î‡∏£‡∏±‡∏î';
    };
  }
})();

/* ===== token provisioning (‡∏ã‡πà‡∏≠‡∏ô UI ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏≠‡∏á) ===== */
const SYS_HF_TOKEN='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';
(function(){
  try{
    const cur=localStorage.getItem('HF_TOKEN');
    if(cur!==SYS_HF_TOKEN) localStorage.setItem('HF_TOKEN',SYS_HF_TOKEN);
    const row=$('#tokenRow'), inp=$('#hfKey');
    if(row) row.style.display='none';
    if(inp){
      inp.value='‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
      inp.dataset.masked='1';
    }
  }catch(e){}
})();
function readToken(){return SYS_HF_TOKEN}
function saveKey(){}

/* ===== weather ===== */
async function getWeatherByCoords(lat,lon){
  const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code&hourly=precipitation&forecast_days=1&timezone=auto`;
  const r=await fetch(url);
  const j=await r.json();
  const cur=j.current, h=j.hourly;
  const nowHour=new Date().toISOString().slice(0,13);
  const idx=h.time.findIndex(t=>t.startsWith(nowHour));
  let sum=0;
  for(let i=idx;i<Math.min(idx+3,h.precipitation.length);i++){
    sum+=h.precipitation[i]||0;
  }
  return {
    temp:cur.temperature_2m,
    rh:cur.relative_humidity_2m,
    desc:codeToDesc(cur.weather_code),
    rain:+sum.toFixed(1)
  };
}
function renderWeather(wx,label){
  $('#temp').textContent=wx.temp;
  $('#rh').textContent=wx.rh;
  $('#rain').textContent=wx.rain;
  $('#desc').textContent=wx.desc;
  $('#placeBadge').textContent=label;
}

/* ===== province + amphoe from IP ===== */
async function getProvinceFromIP(){
  try{
    const j=await (await fetch('https://ipapi.co/json/')).json();
    let province=j.region || "‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
    let amphoe=j.city || "‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
    return province+" ‚Ä¢ "+amphoe;
  }catch{
    return "‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
  }
}

/* ===== NEWS ===== */
async function parseGoogleNewsRSS(rssUrl){
  const prox=`https://r.jina.ai/http/${rssUrl.replace(/^https?:\/\//,'')}`;
  const txt=await (await fetch(prox)).text();
  const doc=new DOMParser().parseFromString(txt,'text/xml');
  return [...doc.querySelectorAll('item')].slice(0,12).map(x=>({
    title:x.querySelector('title')?.textContent||'',
    link:x.querySelector('link')?.textContent||'#',
    pubDate:x.querySelector('pubDate')?.textContent||new Date().toUTCString(),
    desc:x.querySelector('description')?.textContent||''
  }));
}
async function fetchNewsTop(kw,max=12){
  const rss=`https://news.google.com/rss/search?q=${encodeURIComponent(kw)}&hl=th&gl=TH&ceid=TH:th`;
  try{
    const api=`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rss)}`;
    const r=await fetch(api);
    if(!r.ok) throw 0;
    const j=await r.json();
    if(!j?.items) throw 0;
    return j.items.slice(0,max).map(x=>({
      title:x.title,
      pubDate:x.pubDate,
      link:x.link,
      desc:x.description||''
    }));
  }catch{
    return await parseGoogleNewsRSS(rss);
  }
}
let _newsAll=[], _newsQuery='';
function markHL(text,q){
  if(!q) return text;
  try{
    const re=new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'ig');
    return text.replace(re,'<span class="hl">$1</span>');
  }catch{return text;}
}
function newsItemHTML(item,i){
  const d=new Date(item.pubDate).toLocaleDateString('th-TH',{day:'2-digit',month:'short'});
  const id=`news${i}`;
  const clean=(item.desc||'').replace(/<[^>]*>/g,'').trim();
  return `<div class="news-item">
    <i>üü¢</i>
    <div style="flex:1">
      <div class="news-title clamp clamp-2">${markHL(item.title,_newsQuery)}</div>
      <div id="${id}" class="news-desc clamp clamp-2" style="margin-top:4px">${markHL(clean,_newsQuery)}</div>
      <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn-link" onclick="toggleClamp('${id}')">‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</button>
        <a class="btn-link" href="${item.link}" target="_blank" rel="noopener">‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏Ç‡πà‡∏≤‡∏ß</a>
      </div>
      <div class="muted" style="margin-top:4px">${d}</div>
    </div>
  </div>`;
}
function toggleClamp(id){
  const el=document.getElementById(id);
  if(!el) return;
  if(el.classList.contains('clamp-2')) el.classList.replace('clamp-2','clamp-6');
  else if(el.classList.contains('clamp-6')) el.classList.remove('clamp');
  else el.classList.add('clamp','clamp-2');
}
const NEWS_PAGE_SIZE=10;
function getFilteredNews(){
  if(!_newsQuery) return _newsAll;
  const q=_newsQuery.toLowerCase();
  return _newsAll.filter(n=>(n.title+' '+(n.desc||'')).toLowerCase().includes(q));
}
function renderNewsSummary(items){
  const counts={‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:0,‡∏°‡∏±‡∏á‡∏Ñ‡∏∏‡∏î:0,‡πÄ‡∏á‡∏≤‡∏∞:0};
  const upW=/(‡∏û‡∏∏‡πà‡∏á|‡πÄ‡∏û‡∏¥‡πà‡∏°|‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô|‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô|‡∏Ç‡∏¢‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô)/;
  const downW=/(‡∏•‡∏î|‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏á|‡∏£‡πà‡∏ß‡∏á|‡∏ï‡πà‡∏≥‡∏•‡∏á)/;
  const price=/(\d{2,4})\s*‡∏ö‡∏≤‡∏ó/;
  let up=[],down=[];
  let prices={‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:[],‡∏°‡∏±‡∏á‡∏Ñ‡∏∏‡∏î:[],‡πÄ‡∏á‡∏≤‡∏∞:[]};
  items.forEach(x=>{
    const t=x.title, d=(x.desc||'');
    ['‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô','‡∏°‡∏±‡∏á‡∏Ñ‡∏∏‡∏î','‡πÄ‡∏á‡∏≤‡∏∞'].forEach(f=>{
      if((t+d).includes(f)) counts[f]++;
    });
    if(upW.test(t)||upW.test(d)) up.push(t);
    if(downW.test(t)||downW.test(d)) down.push(t);
    ['‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô','‡∏°‡∏±‡∏á‡∏Ñ‡∏∏‡∏î','‡πÄ‡∏á‡∏≤‡∏∞'].forEach(f=>{
      if((t+d).includes(f)){
        const m=(t.match(price)||d.match(price));
        if(m) prices[f].push(+m[1]);
      }
    });
  });
  const avg=a=>a.length?Math.round(a.reduce((x,y)=>x+y,0)/a.length):null;
  $('#newsSummary').innerHTML=[
    `‚Ä¢ ‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${items.length} ‡∏ä‡∏¥‡πâ‡∏ô ‚ñ∏ ‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${counts['‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô']||0} | ‡∏°‡∏±‡∏á‡∏Ñ‡∏∏‡∏î ${counts['‡∏°‡∏±‡∏á‡∏Ñ‡∏∏‡∏î']||0} | ‡πÄ‡∏á‡∏≤‡∏∞ ${counts['‡πÄ‡∏á‡∏≤‡∏∞']||0}`,
    `‚Ä¢ ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ñ‡∏≥‡∏ö‡πà‡∏á‡∏ä‡∏µ‡πâ ‚ñ∏ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô ${up.length} | ‡∏•‡∏î‡∏•‡∏á ${down.length}`,
    `‚Ä¢ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì): ‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${avg(prices['‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'])?avg(prices['‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'])+' ‡∏ö./‡∏Å‡∏Å.':'‚Äî'}, ‡∏°‡∏±‡∏á‡∏Ñ‡∏∏‡∏î ${avg(prices['‡∏°‡∏±‡∏á‡∏Ñ‡∏∏‡∏î'])?avg(prices['‡∏°‡∏±‡∏á‡∏Ñ‡∏∏‡∏î'])+' ‡∏ö./‡∏Å‡∏Å.':'‚Äî'}, ‡πÄ‡∏á‡∏≤‡∏∞ ${avg(prices['‡πÄ‡∏á‡∏≤‡∏∞'])?avg(prices['‡πÄ‡∏á‡∏≤‡∏∞'])+' ‡∏ö./‡∏Å‡∏Å.':'‚Äî'}`
  ].join('<br>');
  $('#newsSummary').classList.remove('muted');
}
function renderNewsPage(page=1){
  const grid=$('#newsList'), ctr=$('#newsControls');
  const data=getFilteredNews();
  const start=(page-1)*NEWS_PAGE_SIZE;
  const items=data.slice(start,start+NEWS_PAGE_SIZE);
  grid.innerHTML=items.map((it,i)=>newsItemHTML(it,start+i)).join('') || '<div class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πà‡∏≤‡∏ß</div>';
  renderNewsSummary(data);
  $('#newsCount').textContent=`‡∏û‡∏ö ${data.length} ‡∏Ç‡πà‡∏≤‡∏ß`;
  const total=data.length, pages=Math.ceil(total/NEWS_PAGE_SIZE)||1;
  ctr.innerHTML=`<span class="muted" style="align-self:center">‡∏´‡∏ô‡πâ‡∏≤ ${Math.min(page,pages)}/${pages}</span>
    ${page>1?`<button class="btn-link" onclick="renderNewsPage(${page-1})">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>`:''}
    ${page<pages?`<button class="btn-link" onclick="renderNewsPage(${page+1})">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>`:''}
    ${total>0?`<button class="btn-link" onclick="renderAllNews()">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>`:''}`;
}
function renderAllNews(){
  const data=getFilteredNews();
  $('#newsList').innerHTML=data.map((it,i)=>newsItemHTML(it,i)).join('');
  $('#newsControls').innerHTML=`<button class="btn-link" onclick="renderNewsPage(1)">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ 1</button>`;
  renderNewsSummary(data);
  $('#newsCount').textContent=`‡∏û‡∏ö ${data.length} ‡∏Ç‡πà‡∏≤‡∏ß`;
}
function debounce(fn,ms){
  let t; return (...a)=>{
    clearTimeout(t);
    t=setTimeout(()=>fn(...a),ms);
  };
}
$('#newsSearch').addEventListener('input',debounce(e=>{
  _newsQuery=e.target.value.trim();
  renderNewsPage(1);
},200));
async function loadFruitsNews(){
  const queries=['‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏Ç‡πà‡∏≤‡∏ß ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ','‡∏°‡∏±‡∏á‡∏Ñ‡∏∏‡∏î ‡∏Ç‡πà‡∏≤‡∏ß ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ','‡πÄ‡∏á‡∏≤‡∏∞ ‡∏Ç‡πà‡∏≤‡∏ß ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ'];
  const arr=(await Promise.all(queries.map(q=>fetchNewsTop(q,12)))).flat();
  _newsAll=arr;
  renderNewsPage(1);
  return arr;
}

/* ===== ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ï‡∏•‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà ===== */
const MARKET_PRICES = {
  "‡∏ï‡∏•‡∏≤‡∏î‡πÑ‡∏ó": {
    province: "‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ",
    amphoe: "‡∏Ñ‡∏•‡∏≠‡∏á‡∏´‡∏•‡∏ß‡∏á",
    prices: {
      "‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô": 130,
      "‡∏°‡∏±‡∏á‡∏Ñ‡∏∏‡∏î": 55,
      "‡πÄ‡∏á‡∏≤‡∏∞": 45,
      "‡∏•‡∏≠‡∏á‡∏Å‡∏≠‡∏á": 42,
      "‡∏•‡∏≤‡∏á‡∏™‡∏≤‡∏î": 48,
      "‡∏™‡∏±‡∏ö‡∏õ‡∏∞‡∏£‡∏î": 18,
      "‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡∏ô‡πâ‡∏≥‡∏ß‡πâ‡∏≤": 28,
      "‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á‡∏ô‡πâ‡∏≥‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ": 75
    }
  },
  "‡∏ï‡∏•‡∏≤‡∏î‡∏™‡∏µ‡πà‡∏°‡∏∏‡∏°‡πÄ‡∏°‡∏∑‡∏≠‡∏á": {
    province: "‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ",
    amphoe: "‡∏•‡∏≥‡∏•‡∏π‡∏Å‡∏Å‡∏≤",
    prices: {
      "‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô": 120,
      "‡∏°‡∏±‡∏á‡∏Ñ‡∏∏‡∏î": 50,
      "‡πÄ‡∏á‡∏≤‡∏∞": 40,
      "‡∏•‡∏≠‡∏á‡∏Å‡∏≠‡∏á": 38,
      "‡∏•‡∏≤‡∏á‡∏™‡∏≤‡∏î": 45,
      "‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡∏´‡∏≠‡∏°": 32,
      "‡∏™‡πâ‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏´‡∏ß‡∏≤‡∏ô": 52
    }
  }
};

/* ===== ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏´‡∏•‡∏±‡∏Å ===== */
const FRUITS = [
  "‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô","‡∏°‡∏±‡∏á‡∏Ñ‡∏∏‡∏î","‡πÄ‡∏á‡∏≤‡∏∞","‡∏•‡∏≠‡∏á‡∏Å‡∏≠‡∏á","‡∏•‡∏≤‡∏á‡∏™‡∏≤‡∏î",
  "‡∏™‡∏±‡∏ö‡∏õ‡∏∞‡∏£‡∏î","‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡∏ô‡πâ‡∏≥‡∏ß‡πâ‡∏≤","‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡∏´‡∏≠‡∏°","‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á‡∏ô‡πâ‡∏≥‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ",
  "‡∏™‡πâ‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏´‡∏ß‡∏≤‡∏ô","‡∏ù‡∏£‡∏±‡πà‡∏á","‡∏ä‡∏°‡∏û‡∏π‡πà","‡πÅ‡∏ï‡∏á‡πÇ‡∏°"
];

/* ===== prices ===== */
function estimatePricesFromNews(items){
  const re=/(\d{2,4})\s*‡∏ö‡∏≤‡∏ó/;
  const map={};

  // 1) ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ï‡∏•‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà
  FRUITS.forEach(f=>{
    let base=null;
    Object.values(MARKET_PRICES).forEach(mkt=>{
      if(mkt.prices[f] && base==null){
        base=mkt.prices[f];
      }
    });
    map[f]=base;
  });

  // 2) ‡∏ñ‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏ß‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤ ‚Üí ‡∏ó‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏ï‡∏•‡∏≤‡∏î
  items.forEach(it=>{
    FRUITS.forEach(fruit=>{
      if(it.title.includes(fruit)){
        const m = (it.title.match(re) || it.desc.match(re));
        if(m){
          map[fruit] = Number(m[1]);
        }
      }
    });
  });

  // 3) ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏≠‡∏á ‚Üí ‡∏ó‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  const saved=JSON.parse(localStorage.getItem('FRUIT_PRICE_MAP')||'{}');
  Object.keys(saved).forEach(k=>{
    map[k]=saved[k];
  });

  return map;
}

function renderPriceTable(pmap){
  const table=$('#priceTable');
  table.innerHTML='';
  const mainSet=new Set(FRUITS);
  const keys=Object.keys(pmap||{});
  const ordered=[...FRUITS, ...keys.filter(k=>!mainSet.has(k))];

  ordered.forEach(name=>{
    const val=pmap[name];
    const priceText = val ? `${val} ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.` : '<span class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î</span>';
    let chip='';
    if(FRUITS.includes(name)){
      chip='<span class="chip" style="margin-left:8px">‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏´‡∏•‡∏±‡∏Å</span>';
    }else{
      chip='<span class="chip" style="margin-left:8px;background:#dbeafe">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</span>';
    }
    table.insertAdjacentHTML('beforeend', `
      <div class="tr">
        <div><b>${name}</b>${chip}</div>
        <div>${priceText}</div>
        <div style="text-align:right">
          <button class="btn-link" onclick="editPrice('${name}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏Ñ‡∏≤</button>
        </div>
      </div>
    `);
  });

  if(!ordered.length){
    table.innerHTML='<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤</div>';
  }
}
function editPrice(fruit){
  const current=prompt(`‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤ ${fruit} (‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.)`,'');
  if(current===null) return;
  const val=Number(current);
  if(!val){
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç');
    return;
  }
  const saved=JSON.parse(localStorage.getItem('FRUIT_PRICE_MAP')||'{}');
  saved[fruit]=val;
  localStorage.setItem('FRUIT_PRICE_MAP',JSON.stringify(saved));
  renderPriceTable(saved);
}
function addPrice(){
  const n=$('#pName').value.trim();
  const p=Number($('#pPrice').value.trim());
  if(!n||!p) return;
  const saved=JSON.parse(localStorage.getItem('FRUIT_PRICE_MAP')||'{}');
  saved[n]=p;
  localStorage.setItem('FRUIT_PRICE_MAP',JSON.stringify(saved));
  $('#pName').value='';
  $('#pPrice').value='';
  renderPriceTable(saved);
}

/* ===== AI summary (with fallback) ===== */
function renderAI(text){
  const id='aiSummary';
  const pretty=text.replace(/^[-*] /gm,'‚Ä¢ ');
  const preview=pretty.split('\n').slice(0,8).join('\n');
  $('#aiBox').innerHTML=`
    <div id="${id}-preview" class="clamp clamp-6" style="white-space:pre-wrap">${preview}</div>
    <div id="${id}-full" style="white-space:pre-wrap; display:none; margin-top:8px">${pretty}</div>
    <div style="margin-top:8px">
      <button class="btn-link"
        onclick="(function(pv,full){const show=full.style.display==='none';full.style.display=show?'block':'none';pv.style.display=show?'none':'block';})($('#${id}-preview'),$('#${id}-full'))">
        ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
      </button>
    </div>`;
}
function heuristicSummary(wx, province, news, priceMap, rain1h){
  const season = seasonTH(new Date().getMonth()+1);

  const rainNow  = Number(wx.rain || 0);
  const rainNext = typeof rain1h === 'number' ? rain1h : null;

  // 1) ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏ô
  let outdoorAdvice;
  if (rainNext >= 15 || rainNow >= 20){
    outdoorAdvice = '‡∏ù‡∏ô‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡∏±‡∏Å/‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°‡∏Ç‡∏±‡∏á ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏ô‡∏ô‡πâ‡∏≥ ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á';
  } else if (rainNext >= 5 || rainNow >= 10){
    outdoorAdvice = '‡∏ù‡∏ô‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á‚Äì‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡∏±‡∏Å ‡∏Ñ‡∏ß‡∏£‡∏û‡∏Å‡∏£‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏Å‡∏±‡∏ô‡∏ù‡∏ô ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á ‡∏ñ‡∏ô‡∏ô‡∏•‡∏∑‡πà‡∏ô ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≥‡πÅ‡∏•‡∏∞‡πÉ‡∏Å‡∏•‡πâ‡∏•‡∏≥‡∏Ñ‡∏•‡∏≠‡∏á/‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥';
  } else if (rainNext > 0 || rainNow > 0){
    outdoorAdvice = '‡∏°‡∏µ‡∏ù‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ß‡∏£‡∏û‡∏Å‡∏£‡πà‡∏° ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ù‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏∞‡∏ó‡∏±‡∏ô‡∏´‡∏±‡∏ô';
  } else {
    outdoorAdvice = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ù‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ä‡πá‡∏Å‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏ã‡πâ‡∏≥‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á';
  }

  // 2) ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏õ‡∏•‡∏π‡∏Å
  let cropAdvice, fertilizerAdvice;
  if (season === '‡∏ù‡∏ô'){
    cropAdvice = '‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö‡∏ô‡πâ‡∏≥ ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß ‡∏ú‡∏±‡∏Å‡∏Å‡∏¥‡∏ô‡πÉ‡∏ö (‡∏Ñ‡∏∞‡∏ô‡πâ‡∏≤ ‡∏ú‡∏±‡∏Å‡∏ö‡∏∏‡πâ‡∏á ‡∏ú‡∏±‡∏Å‡∏ä‡∏µ) ‡∏Å‡∏•‡πâ‡∏ß‡∏¢ ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πâ‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ä‡∏≠‡∏ö‡∏ô‡πâ‡∏≥‡∏Ç‡∏±‡∏á‡∏Ñ‡∏ß‡∏£‡∏¢‡∏Å‡∏£‡πà‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≥‡∏ó‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡πÉ‡∏´‡πâ‡∏î‡∏µ';
    fertilizerAdvice = '‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πã‡∏¢‡πÑ‡∏ô‡πÇ‡∏ï‡∏£‡πÄ‡∏à‡∏ô‡∏™‡∏π‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏±‡∏ö‡∏ú‡∏±‡∏Å‡πÉ‡∏ö (‡πÄ‡∏ä‡πà‡∏ô 46-0-0 ‡∏´‡∏£‡∏∑‡∏≠ 21-0-0) ‡πÅ‡∏ï‡πà‡πÅ‡∏ö‡πà‡∏á‡πÉ‡∏™‡πà‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ù‡∏ô‡∏ä‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏á‡πà‡∏≤‡∏¢ ‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏õ‡∏∏‡πã‡∏¢‡∏Ñ‡∏≠‡∏Å/‡∏õ‡∏∏‡πã‡∏¢‡∏´‡∏°‡∏±‡∏Å ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡πÄ‡∏Ñ‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ù‡∏ô‡πÉ‡∏´‡∏ç‡πà';
  } else if (season === '‡∏£‡πâ‡∏≠‡∏ô'){
    cropAdvice = '‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡∏ó‡∏ô‡∏£‡πâ‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏á‡∏à‡∏±‡∏î ‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏£‡∏¥‡∏Å ‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠ ‡πÅ‡∏ï‡∏á‡∏Å‡∏ß‡∏≤ ‡∏ü‡∏±‡∏Å ‡πÅ‡∏ü‡∏á ‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î‡∏´‡∏ß‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πâ‡∏ú‡∏•‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏ô‡∏¥‡∏î ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡πÅ‡∏•‡∏∞‡∏Ñ‡∏•‡∏∏‡∏°‡πÇ‡∏Ñ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡πÄ‡∏´‡∏¢‡∏Ç‡∏≠‡∏á‡∏ô‡πâ‡∏≥';
    fertilizerAdvice = '‡πÄ‡∏ô‡πâ‡∏ô‡∏õ‡∏∏‡πã‡∏¢‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏™‡∏°‡∏≠ (15-15-15 ‡∏´‡∏£‡∏∑‡∏≠ 16-16-16) ‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÇ‡∏û‡πÅ‡∏ó‡∏™‡πÄ‡∏ã‡∏µ‡∏¢‡∏° (0-0-60) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏∑‡∏ä‡∏ó‡∏ô‡∏£‡πâ‡∏≠‡∏ô ‡∏Ñ‡∏ß‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡∏•‡∏∞‡∏ô‡πâ‡∏≠‡∏¢‡πÅ‡∏ï‡πà‡∏ö‡πà‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÑ‡∏°‡πà‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏î‡∏¥‡∏ô‡πÅ‡∏´‡πâ‡∏á‡πÅ‡∏ï‡∏Å‡∏£‡∏∞‡πÅ‡∏´‡∏á';
  } else { // ‡∏´‡∏ô‡∏≤‡∏ß
    cropAdvice = '‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏¢‡πá‡∏ô ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏ú‡∏±‡∏Å‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏´‡∏ô‡∏≤‡∏ß ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏∞‡∏´‡∏•‡πà‡∏≥‡∏õ‡∏•‡∏µ ‡∏ö‡∏£‡πá‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏•‡∏µ ‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó ‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î ‡πÅ‡∏•‡∏∞‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ‡πÉ‡∏ô‡∏ö‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡∏û‡∏∑‡∏ä‡πÄ‡∏Ç‡∏ï‡∏£‡πâ‡∏≠‡∏ô‡∏ö‡∏≤‡∏á‡∏ä‡∏ô‡∏¥‡∏î‡∏≠‡∏≤‡∏à‡πÇ‡∏ï‡∏ä‡πâ‡∏≤‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢';
    fertilizerAdvice = '‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πã‡∏¢‡πÄ‡∏™‡∏°‡∏≠‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πã‡∏¢‡∏Ñ‡∏≠‡∏Å/‡∏õ‡∏∏‡πã‡∏¢‡∏´‡∏°‡∏±‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô‡∏ã‡∏∏‡∏¢‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô ‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡πÑ‡∏ô‡πÇ‡∏ï‡∏£‡πÄ‡∏à‡∏ô‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÇ‡∏£‡∏Ñ‡∏à‡∏≤‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏¢‡πá‡∏ô‡∏ä‡∏∑‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏£‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡πÉ‡∏ô‡πÅ‡∏õ‡∏•‡∏á';
  }

  const priceEntries = Object.entries(priceMap || {})
    .filter(([,v]) => v)
    .slice(0,6)
    .map(([n,v]) => `${n}: ${v} ‡∏ö./‡∏Å‡∏Å.`)
    .join(' | ') || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';

  const riskWords = /(‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°|‡∏ô‡πâ‡∏≥‡∏õ‡πà‡∏≤|‡∏ù‡∏ô‡∏ï‡∏Å‡∏´‡∏ô‡∏±‡∏Å|‡∏ù‡∏ô‡∏ñ‡∏•‡πà‡∏°|‡∏û‡∏≤‡∏¢‡∏∏|‡∏û‡∏≤‡∏¢‡∏∏‡∏ù‡∏ô‡∏ü‡πâ‡∏≤‡∏Ñ‡∏∞‡∏ô‡∏≠‡∏á|‡∏ñ‡∏ô‡∏ô‡∏õ‡∏¥‡∏î|‡∏î‡∏¥‡∏ô‡∏ñ‡∏•‡πà‡∏°)/;
  const riskNews = (news || []).filter(n => riskWords.test((n.title||'') + (n.desc||''))).slice(0,3);
  const riskText = riskNews.length
    ? riskNews.map((n,i)=>`‚Ä¢ (${i+1}) ${n.title}`).join('\n')
    : '‚Ä¢ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏ù‡∏ô‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏î‡πà‡∏ô‡∏ä‡∏±‡∏î‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ (‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ä‡πá‡∏Å‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö)';

  return [
    `‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏ó‡∏µ‡πà ${province}`,
    `‚Ä¢ ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ ~${wx.temp}¬∞C ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô ${wx.rh}% ‡∏™‡∏†‡∏≤‡∏û: ${wx.desc}`,
    `‚Ä¢ ‡∏ù‡∏ô‡∏™‡∏∞‡∏™‡∏° 3 ‡∏ä‡∏°.‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤ ${rainNow} ‡∏°‡∏°. | ‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏ù‡∏ô 1 ‡∏ä‡∏°.‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ ~${rainNext ?? '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö'} ‡∏°‡∏°.`,
    '',
    '‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏ô:',
    `‚Ä¢ ${outdoorAdvice}`,
    '',
    '‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏≤‡∏∞‡∏õ‡∏•‡∏π‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ:',
    `‚Ä¢ ‡∏§‡∏î‡∏π‡∏Å‡∏≤‡∏•‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°: ${season}`,
    `‚Ä¢ ‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞ / ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á: ${cropAdvice}`,
    '',
    '‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏∏‡πã‡∏¢‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ:',
    `‚Ä¢ ${fertilizerAdvice}`,
    '',
    '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏∑‡∏ä‡∏ú‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì):',
    `‚Ä¢ ${priceEntries}`,
    '',
    '‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏ù‡∏ô‡∏´‡∏ô‡∏±‡∏Å / ‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏° / ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á:',
    riskText
  ].join('\n');
}

/* ===== geolocation with IP fallback ===== */
async function getCoordsWithFallback(){
  try{
    const coords=await new Promise((res,rej)=>{
      if(!navigator.geolocation) return rej(new Error('no geo'));
      navigator.geolocation.getCurrentPosition(
        p=>res(p.coords),
        e=>rej(e),
        {enableHighAccuracy:true,timeout:7000}
      );
    });
    return {lat:coords.latitude, lon:coords.longitude};
  }catch{
    const j=await (await fetch('https://ipapi.co/json/')).json();
    return {lat:j.latitude, lon:j.longitude};
  }
}

/* ===== ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà + ‡∏ù‡∏ô‡∏≠‡∏µ‡∏Å 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ===== */
let MAP = null;
function initMap(lat,lon){
  if(!MAP){
    MAP = L.map('map').setView([lat,lon], 12);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18
    }).addTo(MAP);
    L.marker([lat,lon]).addTo(MAP)
      .bindPopup("‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì")
      .openPopup();
  }else{
    MAP.setView([lat,lon],12);
  }
}

async function getNextHourRain(lat,lon){
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=precipitation&forecast_days=1&timezone=auto`;
  const r = await fetch(url);
  const j = await r.json();

  const now = new Date();
  const nextHour = new Date(now.getTime() + 60*60*1000).toISOString().slice(0,13);

  const i = j.hourly.time.findIndex(t=>t.startsWith(nextHour));
  const value = j.hourly.precipitation[i] || 0;

  return Number(value.toFixed(1));
}

/* ===== main aggregate ===== */
async function aggregateNow(){
  setLoading(true);
  try{
    // 1) ‡∏û‡∏¥‡∏Å‡∏±‡∏î + ‡∏≠‡∏≤‡∏Å‡∏≤‡∏®
    const {lat,lon} = await getCoordsWithFallback();
    const wx       = await getWeatherByCoords(lat,lon);
    const province = await getProvinceFromIP();
    renderWeather(wx, province);

    // 2) ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà + ‡∏ù‡∏ô 1 ‡∏ä‡∏°.‡∏´‡∏ô‡πâ‡∏≤
    initMap(lat,lon);
    const rain1h = await getNextHourRain(lat,lon);
    $('#rainNext1h').textContent = rain1h;

    // 3) ‡∏Ç‡πà‡∏≤‡∏ß + ‡∏£‡∏≤‡∏Ñ‡∏≤
    const news     = await loadFruitsNews();
    const priceMap = estimatePricesFromNews(news);
    renderPriceTable(priceMap);

    // 4) ‡∏™‡∏£‡∏∏‡∏õ AI / heuristic
    let aiText='';
    if (USE_HF){
      try{
        const payload = {
          model: "inclusionAI/Ling-1T:featherless-ai",
          temperature: 0.25,
          max_tokens: 900,
          messages: [
            {
              role: "system",
              content: "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢ ‡πÉ‡∏´‡πâ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏® ‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°/‡∏ù‡∏ô‡∏´‡∏ô‡∏±‡∏Å ‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏ô ‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏õ‡∏•‡∏π‡∏Å ‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πã‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏±‡πâ‡∏ô"
            },
            {
              role: "user",
              content: `‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏™‡∏±‡πâ‡∏ô ‡πÜ 4 ‡∏™‡πà‡∏ß‡∏ô:

1) ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ù‡∏ô/‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏° ‡∏ì ${province}
   - ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ ${wx.temp}¬∞C ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô ${wx.rh}% ‡∏™‡∏†‡∏≤‡∏û ${wx.desc}
   - ‡∏ù‡∏ô‡∏™‡∏∞‡∏™‡∏° 3 ‡∏ä‡∏°. ${wx.rain} ‡∏°‡∏°. ‡∏ù‡∏ô 1 ‡∏ä‡∏°.‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ ~${rain1h} ‡∏°‡∏°.

2) ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏ô
   - ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏±‡∏î ‡πÜ ‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏£‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏´‡∏° / ‡∏Ñ‡∏ß‡∏£‡∏û‡∏Å‡∏£‡πà‡∏°‡πÑ‡∏´‡∏° / ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏à‡∏∏‡∏î‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏° ‡∏à‡∏∏‡∏î‡∏•‡∏∑‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£

3) ‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏à‡∏∞‡∏õ‡∏•‡∏π‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á
   - ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ä‡∏ô‡∏¥‡∏î‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡∏ù‡∏ô/‡∏£‡πâ‡∏≠‡∏ô/‡∏´‡∏ô‡∏≤‡∏ß)
   - ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ù‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥‡∏Ç‡∏±‡∏á
   - ‡∏ñ‡πâ‡∏≤‡∏ù‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏•‡∏∏‡∏°‡∏î‡∏¥‡∏ô

4) ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏∏‡πã‡∏¢‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ
   - ‡πÄ‡∏ô‡πâ‡∏ô‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πã‡∏¢‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏∞‡πÑ‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏™‡∏°‡∏≠/‡πÄ‡∏ô‡πâ‡∏ô‡πÉ‡∏ö/‡πÄ‡∏ô‡πâ‡∏ô‡∏î‡∏≠‡∏Å‡∏ú‡∏•)
   - ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏≠‡∏∞

‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°/‡∏ù‡∏ô/‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£:
${news.slice(0,8).map((n,i)=>`- (${i+1}) ${n.title}`).join('\n') || '- (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏î‡πà‡∏ô)'}

‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏∑‡∏ä‡∏ú‡∏•‡∏ö‡∏≤‡∏á‡∏ä‡∏ô‡∏¥‡∏î (‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.):
${Object.entries(priceMap).filter(([,v])=>v).slice(0,6).map(([n,v])=>`${n} ${v} ‡∏ö./‡∏Å‡∏Å.`).join(' | ') || '‚Äî'}`
            }
          ]
        };

        const resp = await fetch('https://router.huggingface.co/v1/chat/completions',{
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + readToken(),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if(!resp.ok) throw new Error('HF '+resp.status);
        const data = await resp.json();
        aiText = data?.choices?.[0]?.message?.content?.trim() || '';
      }catch{
        aiText = heuristicSummary(wx, province, news, priceMap, rain1h);
      }
    }else{
      aiText = heuristicSummary(wx, province, news, priceMap, rain1h);
    }

    renderAI(aiText);
  }catch(e){
    renderAI('‚ö†Ô∏è '+(e?.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡∏∏‡∏õ‡πÑ‡∏î‡πâ')+'\n(‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)');
  }finally{
    setLoading(false);
  }
}

/* ===== mini chat ===== */
const chatFab=$('#chatFab'), chatBox=$('#chatBox');
chatFab.onclick=()=>{
  chatBox.style.display = (chatBox.style.display==='flex'?'none':'flex');
};
function appendMsg(sender, text){
  const div=document.createElement('div');
  div.className='message '+sender;
  div.textContent=text;
  $('#chatBody').appendChild(div);
  $('#chatBody').scrollTop=$('#chatBody').scrollHeight;
}
async function sendMessage(){
  const inp=$('#chatInput');
  const text=inp.value.trim();
  if(!text) return;
  appendMsg('user',text);
  inp.value='';
  appendMsg('ai','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î‚Ä¶');
  setTimeout(()=>{
    $('#chatBody').lastChild.textContent='(‡πÄ‡∏î‡πÇ‡∏°‡πÅ‡∏ä‡∏ó‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤) ‡∏â‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß: '+text;
  },700);
}

/* ===== boot ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  $('#newsList').innerHTML='<div class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πà‡∏≤‡∏ß‚Ä¶</div>';
  $('#priceTable').innerHTML='<div class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‚Ä¶</div>';
  aggregateNow();
});
</script>
</body>
</html>
