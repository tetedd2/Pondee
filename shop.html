<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --green:#1f9d47;
    --green-dark:#0f7a32;
    --bg:#e9f8ee;
    --card:#fff;
    --shadow:0 4px 10px rgba(0,0,0,.1);
  }
  *{box-sizing:border-box}
  body{
    font-family:'Prompt',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    background:var(--bg);
    margin:0;
    color:#123;
  }
  h1{ text-align:center; color:var(--green); margin:20px 10px 8px}
  .sub{ text-align:center; color:#456; margin-bottom:8px; font-size:14px}

  .container{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
    gap:15px;
    padding:20px;
    max-width:900px;
    margin:auto;
  }
  .product{
    background:var(--card);
    border-radius:15px;
    box-shadow:var(--shadow);
    text-align:center;
    padding:15px;
    transition:transform .1s ease;
  }
  .product:hover{ transform:translateY(-2px)}
  .product img{ width:100px; height:100px; object-fit:contain}
  .price{ font-weight:600; color:#2b6; margin:6px 0 10px}
  .muted{ color:#678; font-size:12px}

  button{
    background:var(--green);
    color:#fff;
    border:none;
    padding:8px 14px;
    border-radius:10px;
    cursor:pointer;
    font-size:14px;
  }
  button:hover{ background:var(--green-dark)}

  .cart-icon{
    position:fixed;
    top:15px;
    right:15px;
    background:#28a745;
    color:#fff;
    padding:10px 12px;
    border-radius:999px;
    cursor:pointer;
    font-size:20px;
    box-shadow:0 3px 8px rgba(0,0,0,.2);
    display:flex;
    align-items:center;
    gap:8px;
    user-select:none;
    z-index:1090;
  }
  .badge{
    background:#fff;
    color:#28a745;
    font-weight:700;
    min-width:22px;
    height:22px;
    border-radius:999px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-size:12px;
    padding:0 6px;
  }
  .cart-toast{
    position:absolute;
    right:100%;
    margin-right:10px;
    top:50%;
    transform:translateY(-50%);
    background:#1f9d47;
    color:#fff;
    font-size:12px;
    padding:6px 10px;
    border-radius:999px;
    box-shadow:0 3px 8px rgba(0,0,0,.2);
    opacity:0;
    pointer-events:none;
    transition:opacity .25s ease, transform .25s ease;
    white-space:nowrap;
  }
  .cart-toast.show{
    opacity:1;
    transform:translateY(-50%) translateX(-2px);
  }

  .modal,.popup{
    display:none;
    position:fixed;
    z-index:1000;
    inset:0;
    background:rgba(0,0,0,.4);
    padding:16px;
  }
  .modal-content,.popup-content{
    background:#fff;
    margin:6% auto 0;
    padding:20px;
    border-radius:15px;
    width:100%;
    max-width:520px;
    box-shadow:var(--shadow);
    text-align:center;
    position:relative;
  }
  .close{
    position:absolute;
    right:12px;
    top:10px;
    font-size:22px;
    cursor:pointer;
    color:#678;
  }

  .cart-item{
    display:grid;
    grid-template-columns:1fr auto auto;
    gap:10px;
    align-items:center;
    margin:10px 0;
    text-align:left;
  }
  .cart-name{ font-weight:600}
  .ctrl{
    display:inline-flex;
    align-items:center;
    gap:6px;
    border:1px solid #dde;
    border-radius:8px;
    padding:4px 6px;
    background:#f9fbfa;
  }
  .ctrl input{
    width:56px;
    padding:6px 4px;
    border:1px solid #ccd;
    border-radius:6px;
    text-align:center;
    font-size:14px;
  }
  .ctrl button{
    padding:6px 10px;
    border-radius:8px;
    background:#eaf7ef;
    color:#177a3a;
  }
  .ctrl button:hover{ background:#d9f1e2}
  .remove-btn{
    background:#ff4d4f;
    padding:6px 10px;
    border-radius:8px;
    font-size:12px;
    color:#fff;
  }
  .remove-btn:hover{ background:#d9363e}
  .checkout{
    background:var(--green);
    color:#fff;
    padding:12px 20px;
    border-radius:12px;
    display:block;
    text-align:center;
    margin:15px auto 0;
    width:100%;
    font-size:16px;
  }
  .clear-cart{
    background:#f1f3f5;
    color:#345;
    margin-top:10px;
  }
  .btn-secondary{
    background:#eef1f5;
    color:#234;
  }

  .popup-content .row{
    text-align:left;
    margin:10px auto;
    max-width:320px;
  }
  .popup-content label{
    font-size:14px;
    color:#456;
  }
  .popup-content input[type="number"],
  .popup-content select{
    width:100%;
    padding:10px;
    margin-top:8px;
    border-radius:8px;
    border:1px solid #ccd;
    font-size:16px;
    background:#fff;
  }
  .popup-actions{
    display:flex;
    gap:10px;
    margin-top:14px;
  }
  .popup-actions button{ flex:1 }
  .total-row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-weight:700;
    font-size:16px;
    margin-top:8px;
  }
  .hr{
    height:1px;
    background:#eee;
    margin:12px 0;
  }

  .pay-methods{
    display:grid;
    grid-template-columns:1fr 1fr 1fr;
    gap:10px;
    margin:10px 0 6px;
  }
  .radio-card{
    border:1px solid #dde;
    border-radius:12px;
    padding:10px;
    cursor:pointer;
    user-select:none;
    display:flex;
    align-items:center;
    gap:8px;
    justify-content:center;
    background:#fafdfb;
  }
  .radio-card input{ accent-color:#1f9d47 }
  .radio-card.active{
    border-color:#1f9d47;
    background:#f0fbf4;
  }
  .pay-pane{ display:none; text-align:left }
  .pay-pane.active{ display:block }
  .qr-wrap{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:8px;
    margin-top:10px;
  }
  .qr-box{
    background:#fff;
    padding:10px;
    border-radius:12px;
    box-shadow:var(--shadow);
  }
  .copy-btn{
    background:#f1f3f5;
    color:#345;
  }
  .sum-line{
    display:flex;
    justify-content:space-between;
    margin:6px 0;
  }
  .addr-area{
    width:100%;
    min-height:86px;
    padding:10px;
    border-radius:10px;
    border:1px solid #ccd;
    resize:vertical;
  }
  .file-row{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
  .thumb{
    width:120px;
    height:120px;
    border-radius:12px;
    object-fit:cover;
    background:#f5f7f9;
    display:none;
  }
  .success-box{
    background:#f0fbf4;
    border:1px solid #cfead6;
    border-radius:12px;
    padding:12px;
    margin-top:10px;
    color:#135a2c;
    display:none;
  }

  .history-list{
    text-align:left;
    max-height:55vh;
    overflow:auto;
    padding-right:6px;
  }
  .order-card{
    border:1px solid #edf;
    border-radius:12px;
    padding:12px;
    margin:10px 0;
    background:#fbfdff;
  }
  .order-head{
    display:flex;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .order-items{
    margin-top:8px;
    color:#345;
    font-size:14px;
  }
  .order-items li{ margin:3px 0 }

  .eta{
    background:#f5fff7;
    border:1px dashed #9ed3b1;
    padding:10px;
    border-radius:10px;
    color:#165b2e;
    margin:8px 0;
  }

  .button-container-bottom {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    display: flex;
    justify-content: space-around;
    gap: 10px;
    background-color: white;
    padding: 8px 0;
    box-shadow: 0 -2px 6px rgba(0,0,0,.1);
    z-index: 1000;
  }
  .btn-bottom {
    background-color: transparent;
    border: none;
    cursor: pointer;
    flex: 1;
    height: 60px;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    padding:0;
    text-decoration:none;
    transition:.3s;
    box-shadow:none;
  }
  .btn-bottom img {
    width: 80px;
    height: auto;
    object-fit: contain;
    display: block;
  }
  .btn-bottom:hover { transform: scale(1.05); }
  .btn-bottom:active { transform: scale(0.98); }
  .btn-bottom img { width: 100%; height: 100%; object-fit: cover; }
  .btn-bottom:hover { box-shadow: 0 6px 16px rgba(0,0,0,.15); }

  /* ===== ‡∏ï‡∏•‡∏≤‡∏î‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ===== */
  #marketSection{ padding-bottom:80px; }
  .market-layout{
    max-width:1000px;
    margin:0 auto;
    padding:20px;
    display:grid;
    grid-template-columns:minmax(0,340px) minmax(0,1fr);
    gap:20px;
    align-items:flex-start;
  }
  .market-form{
    background:#fff;
    border-radius:15px;
    box-shadow:var(--shadow);
    padding:16px;
  }
  .market-form h3{ margin-top:0; margin-bottom:6px; }
  .market-form .muted{ font-size:11px; }
  .market-form label{
    display:block;
    margin-top:10px;
    margin-bottom:4px;
    font-size:13px;
    color:#345;
  }
  .market-form input,
  .market-form textarea,
  .market-form select{
    width:100%;
    padding:10px;
    border-radius:8px;
    border:1px solid #ccd;
    font-size:14px;
  }
  .market-form textarea{ min-height:80px; resize:vertical; }
  .market-form .market-row-2{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }
  .market-form button[type="submit"]{
    width:100%;
    margin-top:14px;
  }

  .market-list-empty{
    padding:25px;
    text-align:center;
    background:#f5faf7;
    border-radius:15px;
    border:1px dashed #cdebd5;
    color:#456;
    font-size:13px;
  }
  .market-card{
    text-align:left;
  }
  .market-card h3{
    margin-top:0;
    margin-bottom:4px;
  }
  .market-card .muted{
    display:block;
    margin-top:3px;
  }
  .market-card .market-contact{
    margin-top:8px;
    font-size:12px;
  }
  .market-card .market-contact a{
    color:#1f7bd8;
    text-decoration:none;
    word-break:break-all;
  }
  .market-card .market-contact a:hover{text-decoration:underline;}
  .market-card .remove-btn{
    margin-top:10px;
  }

  /* badge ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® + ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå */
  .trade-badge{
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
    font-size:11px;
    margin-bottom:4px;
  }
  .trade-sell{
    background:#e8fff1;
    color:#1f7a3a;
  }
  .trade-buy{
    background:#e8f4ff;
    color:#1452a6;
  }
  .owner-line{
    font-size:12px;
    margin-top:4px;
  }

  @media (max-width:768px){
    .market-layout{
      grid-template-columns:1fr;
    }
  }

  /* ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */
  .view-toggle{
    position:fixed;
    top:10px;
    left:10px;
    z-index:1100;
  }
  .view-toggle button{
    background:#ffffff;
    color:var(--green-dark);
    border:1px solid rgba(0,0,0,.08);
    border-radius:999px;
    padding:6px 14px;
    font-size:13px;
    box-shadow:var(--shadow);
    cursor:pointer;
  }
  .view-toggle button:hover{
    background:var(--green);
    color:#fff;
  }
</style>
</head>
<body>

<!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß -->
<div class="view-toggle">
  <button id="btnToggleView" type="button" onclick="toggleView()">
    ‡∏ï‡∏•‡∏≤‡∏î‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
  </button>
</div>

<!-- ‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏∏‡πã‡∏¢‡∏´‡∏•‡∏±‡∏Å -->
<div id="shopSection">
  <h1>üõí ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h1>
  <p class="sub">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ö‡∏ö ‚Äú‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°‚Äù ‡πÅ‡∏•‡∏∞ ‚Äú‡∏ñ‡∏∏‡∏á‚Äù ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>

  <div class="cart-icon" onclick="openCart()" aria-label="‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" role="button">
    <span class="cart-toast" id="cartToast" aria-live="polite">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß</span>
    üõçÔ∏è <span class="badge" id="cartBadge">0</span>
  </div>

  <div class="container" id="productList"></div>
</div>

<!-- ‡∏ï‡∏•‡∏≤‡∏î‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ -->
<div id="marketSection" style="display:none">
  <h1>üçã ‡∏ï‡∏•‡∏≤‡∏î‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h1>
  <p class="sub">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏•‡∏á‡∏Ç‡∏≤‡∏¢‡∏ú‡∏•‡πÑ‡∏°‡πâ ‡∏ö‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á ‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</p>

  <div class="market-layout">
    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡∏á‡∏Ç‡∏≤‡∏¢ -->
    <form id="marketForm" class="market-form">
      <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏ô‡∏ï‡∏•‡∏≤‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
      <p class="muted">
        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏û‡∏™‡∏ï‡πå <b>‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢</b> ‡∏´‡∏£‡∏∑‡∏≠ <b>‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</b><br>
        ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏¥‡∏î‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      </p>

      <label for="tradeType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® *</label>
      <select id="tradeType" required>
        <option value="sell">üî• ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢</option>
        <option value="buy">üõí ‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</option>
      </select>

      <label for="ownerName">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå *</label>
      <input id="ownerName" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡πâ‡∏≠‡∏á‡∏û‡∏•‡∏≠‡∏¢, ‡∏£‡πâ‡∏≤‡∏ô‡∏™‡∏ß‡∏ô‡∏•‡∏∏‡∏á‡∏™‡∏°‡∏ä‡∏≤‡∏¢">

      <label for="fruitName">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏•‡πÑ‡∏°‡πâ *</label>
      <input id="fruitName" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏°‡∏≠‡∏ô‡∏ó‡∏≠‡∏á, ‡∏°‡∏±‡∏á‡∏Ñ‡∏∏‡∏î, ‡πÄ‡∏á‡∏≤‡∏∞">

      <div class="market-row-2">
        <div>
          <label for="price">‡∏£‡∏≤‡∏Ñ‡∏≤ *</label>
          <input id="price" type="number" min="0" step="1" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 120">
        </div>
        <div>
          <label for="unit">‡∏´‡∏ô‡πà‡∏ß‡∏¢ *</label>
          <input id="unit" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å., ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏•‡πà‡∏≠‡∏á">
        </div>
      </div>

      <label for="location">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà/‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢ *</label>
      <input id="location" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠.‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡∏≤ ‡∏à.‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å">

      <label for="shipping">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á *</label>
      <input id="shipping" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡πà‡∏á‡πÉ‡∏ô‡∏≠‡∏≥‡πÄ‡∏†‡∏≠, J&T, Kerry, ‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö">

      <div class="market-row-2">
        <div>
          <label for="phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ *</label>
          <input id="phone" required placeholder="0XXXXXXXXX">
        </div>
        <div>
          <label for="contact">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô</label>
          <input id="contact" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå LINE / Facebook / IG (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
        </div>
      </div>

      <label for="note">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
      <textarea id="note" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏•‡∏π‡∏Å‡πÄ‡∏≠‡∏á ‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå ‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡πÄ‡∏Å‡∏£‡∏î"></textarea>

      <button type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏•‡∏≤‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
    </form>

    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® -->
    <div id="marketList"></div>
  </div>
</div>

<!-- Popup ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏∑‡πâ‡∏≠ -->
<div id="popup" class="popup" aria-hidden="true">
  <div class="popup-content" role="dialog" aria-modal="true">
    <span class="close" onclick="closePopup()" aria-label="‡∏õ‡∏¥‡∏î">&times;</span>
    <h3>üßÆ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
    <p class="muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</p>
    <div class="row">
      <label>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
      <div id="popupProductName" style="font-weight:600; margin-top:6px;">-</div>
    </div>
    <div class="row">
      <label for="typeSelect">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö</label>
      <select id="typeSelect">
        <option value="kg">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</option>
        <option value="bag">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ñ‡∏∏‡∏á</option>
      </select>
    </div>
    <div class="row">
      <label for="quantityInput">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
      <input type="number" id="quantityInput" placeholder="‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" min="0.1" step="0.1" />
      <div id="unitHint" class="muted" style="margin-top:6px;">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô ‡∏Å‡∏Å.</div>
    </div>
    <div class="row total-row">
      <span>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°:</span>
      <span id="popupTotal">‡∏ø0.00</span>
    </div>
    <div class="popup-actions">
      <button class="clear-cart" onclick="closePopup()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button onclick="confirmAdd()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
    </div>
  </div>
</div>

<!-- ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
<div id="cartModal" class="modal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true">
    <span class="close" onclick="closeCart()" aria-label="‡∏õ‡∏¥‡∏î">&times;</span>
    <h2>üß∫ ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
    <div id="cartItems"></div>
    <div class="hr"></div>
    <div class="total-row">
      <span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
      <span id="total">‡∏ø0.00</span>
    </div>
    <button class="checkout" onclick="openPayment()">üí≥ ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</button>
    <div style="display:flex; gap:10px; justify-content:center; margin-top:10px">
      <button class="clear-cart" onclick="clearCart()">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
      <button class="btn-secondary" onclick="openHistory()">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</button>
    </div>
  </div>
</div>

<!-- ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô -->
<div id="paymentModal" class="modal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true">
    <span class="close" onclick="closePayment()" aria-label="‡∏õ‡∏¥‡∏î">&times;</span>
    <h2>üí≥ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h2>
    <div class="sum-line">
      <span>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</span>
      <strong id="orderId">-</strong>
    </div>
    <div class="sum-line">
      <span>‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞</span>
      <strong id="payTotal">‡∏ø0.00</strong>
    </div>

    <div class="pay-methods" id="payMethods">
      <label class="radio-card active">
        <input type="radio" name="payMethod" value="qr" checked> PromptPay QR
      </label>
      <label class="radio-card">
        <input type="radio" name="payMethod" value="slip"> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ
      </label>
      <label class="radio-card">
        <input type="radio" name="payMethod" value="cod"> ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (COD)
      </label>
    </div>

    <!-- QR -->
    <div id="paneQR" class="pay-pane active">
      <div class="qr-wrap">
        <div class="qr-box">
          <canvas id="qrCanvas" width="240" height="240"></canvas>
        </div>
        <div>‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ PromptPay: <b id="ppIdText">-</b></div>
        <div class="file-row">
          <button class="copy-btn" onclick="copyText(PROMPTPAY_ID)">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</button>
          <button class="copy-btn" onclick="copyAmount()">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô</button>
        </div>
        <label style="display:flex; gap:8px; align-items:center; margin-top:8px">
          <input type="checkbox" id="qrConfirmed">
          <span>‡∏â‡∏±‡∏ô‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
        </label>
      </div>
    </div>

    <!-- Slip -->
    <div id="paneSlip" class="pay-pane">
      <div class="row">
        <label>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô (jpg/png)</label>
        <div class="file-row">
          <input type="file" id="slipInput" accept="image/*" />
          <img id="slipThumb" class="thumb" alt="‡∏™‡∏•‡∏¥‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á">
        </div>
      </div>
    </div>

    <!-- COD -->
    <div id="paneCOD" class="pay-pane">
      <div class="row">
        <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</label>
        <input type="text" id="codName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" />
      </div>
      <div class="row">
        <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
        <input type="tel" id="codPhone" placeholder="0XXXXXXXXX" />
      </div>
      <div class="row">
        <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</label>
        <textarea id="codAddr" class="addr-area" placeholder="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà / ‡∏ñ‡∏ô‡∏ô / ‡∏ï‡∏≥‡∏ö‡∏• / ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ / ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î / ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå"></textarea>
      </div>
    </div>

    <div class="hr"></div>
    <button class="checkout" onclick="confirmPayment()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
    <div id="paySuccess" class="success-box"></div>
  </div>
</div>

<!-- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠ -->
<div id="historyModal" class="modal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true">
    <span class="close" onclick="closeHistory()" aria-label="‡∏õ‡∏¥‡∏î">&times;</span>
    <h2>üßæ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠ (‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ)</h2>
    <div class="history-list" id="historyList"></div>
    <div class="hr"></div>
    <div style="display:flex; gap:10px; justify-content:center">
      <button class="clear-cart" onclick="clearHistory()">‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      <button class="btn-secondary" onclick="closeHistory()">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>
</div>

<!-- Popup ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ä‡∏≥‡∏£‡∏∞ -->
<div id="deliveryModal" class="modal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true">
    <span class="close" onclick="closeDelivery()" aria-label="‡∏õ‡∏¥‡∏î">&times;</span>
    <h2>üöö ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h2>
    <p class="eta"><b id="etaMsg">‡∏Ñ‡∏ô‡∏™‡πà‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡∏≠‡∏á...</b></p>
    <div class="row">
      <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</label>
      <input type="text" id="shipName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" />
    </div>
    <div class="row">
      <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
      <input type="tel" id="shipPhone" placeholder="0XXXXXXXXX" />
    </div>
    <div class="row">
      <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</label>
      <textarea id="shipAddr" class="addr-area" placeholder="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà / ‡∏ñ‡∏ô‡∏ô / ‡∏ï‡∏≥‡∏ö‡∏• / ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ / ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î / ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå"></textarea>
    </div>
    <div class="hr"></div>
    <button class="checkout" onclick="saveDelivery()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà & ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
  </div>
</div>

<!-- Modal ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô‡∏ï‡∏•‡∏≤‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ -->
<div id="commissionModal" class="modal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true">
    <span class="close" onclick="closeCommission()" aria-label="‡∏õ‡∏¥‡∏î">&times;</span>
    <h2>üí∏ ‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô‡∏ï‡∏•‡∏≤‡∏î‡∏ú‡∏•‡πÑ‡∏°‡πâ</h2>
    <p id="commissionSummary" class="muted" style="margin-top:6px;"></p>

    <div class="qr-wrap" style="margin-top:12px;">
      <div class="qr-box">
        <canvas id="commissionQrCanvas" width="240" height="240"></canvas>
      </div>
      <div style="margin-top:6px;">
        ‡πÇ‡∏≠‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ PromptPay: <b id="commissionPPID"></b>
      </div>
      <button class="copy-btn" type="button"
              onclick="copyText(MARKET_COMMISSION_PROMPTPAY_ID)"
              style="margin-top:6px;">
        ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°
      </button>
    </div>

    <p class="muted" style="margin-top:10px;">
      * ‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á QR ‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÅ‡∏≠‡∏õ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    </p>
  </div>
</div>

<!-- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡πà‡∏≤‡∏á -->
<div class="button-container-bottom">
  <a href="Home999.html" class="btn-bottom"><img src="60.png" alt="Home"></a>
  <a href="shop.html"   class="btn-bottom"><img src="333222.png" alt="Shop"></a>
  <a href="Home.html"   class="btn-bottom"><img src="61.png" alt="AI"></a>
  <a href="Home555.html" class="btn-bottom"><img src="62.png" alt="‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡∏•‡∏π‡∏Å"></a>
  <a href="menu.html"   class="btn-bottom"><img src="1000.png" alt="‡πÄ‡∏°‡∏ô‡∏π"></a>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
  /* ===== Config ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyDq60nePWYn2AXt4gkJSqnTlpR84ZfkTUw",
    authDomain: "beneficial-applications.firebaseapp.com",
    projectId: "beneficial-applications",
    storageBucket: "beneficial-applications.firebasestorage.app",
    messagingSenderId: "614255728005",
    appId: "1:614255f6033ed3e452e0ec",
    measurementId: "G-N8RKQSHP94"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const marketRef = db.collection('fruit_market');
  const commissionRef = db.collection('fruit_commissions'); // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°

  const PROMPTPAY_ID = '0812345678'; // ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å
  const MARKET_COMMISSION_RATE = 0.05; // 5% ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏ï‡∏•‡∏≤‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
  const MARKET_COMMISSION_PROMPTPAY_ID = '0812345678'; // ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏° (‡∏à‡∏∞‡πÅ‡∏¢‡∏Å‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏°‡πà‡∏Å‡πá‡πÑ‡∏î‡πâ)

  const THB = new Intl.NumberFormat('th-TH', { style:'currency', currency:'THB' });
  const DT  = new Intl.DateTimeFormat('th-TH', { dateStyle:'medium', timeStyle:'short' });
  const $   = s => document.querySelector(s);

  const CART_KEY='fertilizer_cart',
        HIST_KEY='fertilizer_order_history',
        ADDR_KEY='fertilizer_last_address';

  const PRODUCTS = [
    // üå± ‡∏õ‡∏∏‡πã‡∏¢ 3 ‡∏™‡∏π‡∏ï‡∏£
    {
      id:'organic',
      name:'0-0-60',
      img:'444333.png',
      pricePerKg:120,
      pricePerBag:95,
      bagUnit:'‡∏ñ‡∏∏‡∏á 1 ‡∏Å‡∏Å.'
    },
    {
      id:'chemical',
      name:'15-15-15',
      img:'444222.png',
      pricePerKg:150,
      pricePerBag:135,
      bagUnit:'‡∏ñ‡∏∏‡∏á 1 ‡∏Å‡∏Å.'
    },
    {
      id:'mix',
      name:'15-5-20',
      img:'444555.png',
      pricePerKg:180,
      pricePerBag:160,
      bagUnit:'‡∏ñ‡∏∏‡∏á 1 ‡∏Å‡∏Å.'
    },

    // üíä ‡∏¢‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏û‡∏∑‡∏ä 3 ‡∏™‡∏π‡∏ï‡∏£
    {
      id:'fungicide',
      name:'‡∏¢‡∏≤‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤',
      img:'GPT01.png',
      pricePerKg:250,
      pricePerBag:220,
      bagUnit:'‡∏Ç‡∏ß‡∏î 1 ‡∏•‡∏¥‡∏ï‡∏£'
    },
    {
      id:'insecticide',
      name:'‡∏¢‡∏≤‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢-‡πÅ‡∏°‡∏•‡∏á',
      img:'GPT03.png',
      pricePerKg:280,
      pricePerBag:250,
      bagUnit:'‡∏Ç‡∏ß‡∏î 1 ‡∏•‡∏¥‡∏ï‡∏£'
    },
    {
      id:'caterpillar',
      name:'‡∏¢‡∏≤‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏´‡∏ô‡∏≠‡∏ô',
      img:'GPT02.png',
      pricePerKg:300,
      pricePerBag:270,
      bagUnit:'‡∏Ç‡∏ß‡∏î 1 ‡∏•‡∏¥‡∏ï‡∏£'
    }
  ];

  function saveCartLS(){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); }
  function loadCartLS(){ try{ return JSON.parse(localStorage.getItem(CART_KEY)||'[]'); }catch{ return []; } }
  function saveHistoryLS(arr){ localStorage.setItem(HIST_KEY, JSON.stringify(arr)); }
  function loadHistoryLS(){ try{ return JSON.parse(localStorage.getItem(HIST_KEY)||'[]'); }catch{ return []; } }
  function saveLastAddr(obj){ localStorage.setItem(ADDR_KEY, JSON.stringify(obj)); }
  function loadLastAddr(){ try{ return JSON.parse(localStorage.getItem(ADDR_KEY)||'{}'); }catch{ return {}; } }

  // client id ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏•‡∏≤‡∏î‡∏ú‡∏•‡πÑ‡∏°‡πâ (‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå)
  const CLIENT_ID_KEY = 'fruit_market_client_id';
  function getClientId(){
    let id = localStorage.getItem(CLIENT_ID_KEY);
    if(!id){
      id = 'client_' + Date.now().toString(36) + Math.random().toString(36).slice(2,8);
      localStorage.setItem(CLIENT_ID_KEY, id);
    }
    return id;
  }
  const CLIENT_ID = getClientId();

  let cart = loadCartLS();
  let currentProduct = null;
  let toastTimer = null;
  let lastOrderIdForDelivery = null;
  let marketUnsubscribe = null;

  /* ===== ‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏∏‡πã‡∏¢/‡∏ï‡∏•‡∏≤‡∏î ===== */
  function setView(view){
    const shop   = document.getElementById('shopSection');
    const market = document.getElementById('marketSection');
    const btn    = document.getElementById('btnToggleView');
    if(!shop || !market || !btn) return;

    if(view === 'market'){
      shop.style.display   = 'none';
      market.style.display = 'block';
      btn.textContent      = '‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏∏‡πã‡∏¢';
      btn.dataset.view     = 'market';
    } else {
      shop.style.display   = 'block';
      market.style.display = 'none';
      btn.textContent      = '‡∏ï‡∏•‡∏≤‡∏î‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
      btn.dataset.view     = 'shop';
    }
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
  function toggleView(){
    const btn = document.getElementById('btnToggleView');
    const current = btn?.dataset.view || 'shop';
    setView(current === 'shop' ? 'market' : 'shop');
  }

  /* ===== Render ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏∏‡πã‡∏¢/‡∏¢‡∏≤ ===== */
  function renderProducts(){
    const list = $('#productList');
    if(!list) return;
    list.innerHTML = PRODUCTS.map(p=>`
      <div class="product">
        <img src="${p.img}" alt="">
        <h3>${p.name}</h3>
        <div class="price">‡∏ø${p.pricePerKg.toLocaleString()} / ‡∏Å‡∏Å.</div>
        <div class="muted">‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ö‡∏ö‡∏ñ‡∏∏‡∏á: ‡∏ø${p.pricePerBag.toLocaleString()} (${p.bagUnit})</div>
        <div style="height:10px"></div>
        <button onclick="openPopup('${p.id}')">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
      </div>
    `).join('');
  }

  /* ===== Popup ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ===== */
  function openPopup(id){
    const p = PRODUCTS.find(x=>x.id===id);
    if(!p) return;
    currentProduct = p;
    $('#typeSelect').value='kg';
    $('#quantityInput').value='';
    $('#unitHint').textContent='‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô ‡∏Å‡∏Å.';
    $('#popupProductName').textContent=p.name;
    $('#popupTotal').textContent=THB.format(0);
    $('#popup').style.display='block';
    $('#popup').setAttribute('aria-hidden','false');
    $('#quantityInput').focus();
  }
  function closePopup(){
    $('#popup').style.display='none';
    $('#popup').setAttribute('aria-hidden','true');
    currentProduct = null;
  }
  $('#typeSelect').addEventListener('change', ()=>{
    $('#unitHint').textContent = $('#typeSelect').value==='kg' ? '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô ‡∏Å‡∏Å.' : '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô ‡∏ñ‡∏∏‡∏á';
    updatePopupTotal();
  });
  $('#quantityInput').addEventListener('input', updatePopupTotal);

  function updatePopupTotal(){
    if(!currentProduct) return;
    const type = $('#typeSelect').value;
    const qty = parseFloat($('#quantityInput').value);
    const unit = type==='kg' ? currentProduct.pricePerKg : currentProduct.pricePerBag;
    $('#popupTotal').textContent = THB.format((!isNaN(qty) && qty>0) ? unit * qty : 0);
  }

  function showCartToast(t='‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß'){
    const el = $('#cartToast');
    el.textContent=t;
    el.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>el.classList.remove('show'),1500);
  }

  function confirmAdd(){
    if(!currentProduct) return;
    const type = $('#typeSelect').value;
    const qty = parseFloat($('#quantityInput').value);
    if(isNaN(qty) || qty<=0){
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      return;
    }
    const unit = type==='kg' ? currentProduct.pricePerKg : currentProduct.pricePerBag;
    const i = cart.findIndex(x=>x.id===currentProduct.id && x.type===type);
    if(i>=0){
      cart[i].qty = parseFloat((cart[i].qty + qty).toFixed(2));
    }else{
      cart.push({id:currentProduct.id,name:currentProduct.name,type,qty,unitPrice:unit});
    }
    saveCartLS();
    closePopup();
    updateCart();
    showCartToast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß (${cart.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`);
  }

  /* ===== ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ ===== */
  function openCart(){
    $('#cartModal').style.display='block';
    $('#cartModal').setAttribute('aria-hidden','false');
    updateCart();
  }
  function closeCart(){
    $('#cartModal').style.display='none';
    $('#cartModal').setAttribute('aria-hidden','true');
  }
  function clearCart(){
    if(!cart.length) return;
    if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')){
      cart=[];
      saveCartLS();
      updateCart();
    }
  }
  function removeItem(i){
    cart.splice(i,1);
    saveCartLS();
    updateCart();
  }
  function setQty(i,v){
    const q=parseFloat(v);
    if(isNaN(q) || q<=0) return;
    cart[i].qty = parseFloat(q.toFixed(2));
    saveCartLS();
    updateCart();
  }
  function stepQty(i,d){
    const v = Math.max(0.1, cart[i].qty + d);
    cart[i].qty = parseFloat(v.toFixed(2));
    saveCartLS();
    updateCart();
  }
  function itemLabel(it){ return it.type==='kg' ? `${it.qty} ‡∏Å‡∏Å.` : `${it.qty} ‡∏ñ‡∏∏‡∏á`; }

  function updateCart(){
    const items = $('#cartItems');
    const totalEl = $('#total');
    const badge = $('#cartBadge');
    if(!cart.length){
      items.innerHTML='<p class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>';
      totalEl.textContent=THB.format(0);
      badge.textContent=0;
      return;
    }
    let total=0;
    items.innerHTML = cart.map((it,i)=>{
      const sub = it.unitPrice * it.qty;
      total += sub;
      const unitTxt = it.type==='kg' ? '‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.' : '‡∏ö‡∏≤‡∏ó/‡∏ñ‡∏∏‡∏á';
      return `
        <div class="cart-item">
          <div>
            <div class="cart-name">${it.name} <span class="muted">(${itemLabel(it)})</span></div>
            <div class="muted">‡∏ø${it.unitPrice.toLocaleString()} / ${unitTxt}</div>
          </div>
          <div class="ctrl">
            <button onclick="stepQty(${i},-0.1)">‚àí</button>
            <input type="number" step="0.1" min="0.1" value="${it.qty}" onchange="setQty(${i},this.value)">
            <button onclick="stepQty(${i},+0.1)">+</button>
          </div>
          <div style="text-align:right">
            <div><strong>${THB.format(sub)}</strong></div>
            <button class="remove-btn" onclick="removeItem(${i})">‡∏•‡∏ö</button>
          </div>
        </div>
      `;
    }).join('');
    totalEl.textContent = THB.format(total);
    badge.textContent = cart.length;
  }

  /* ===== EMV PromptPay ===== */
  function tlv(id,val){ const len=val.length.toString().padStart(2,'0'); return id+len+val; }
  function crc16ccitt(str){
    let crc=0xFFFF;
    for(let i=0;i<str.length;i++){
      crc ^= (str.charCodeAt(i) << 8);
      for(let j=0;j<8;j++){
        if(crc & 0x8000) crc = (crc<<1) ^ 0x1021;
        else crc <<= 1;
        crc &= 0xFFFF;
      }
    }
    return crc.toString(16).toUpperCase().padStart(4,'0');
  }
  function normalizePP(id){
    const d=(id||'').replace(/\D/g,'');
    if(/^0\d{9}$/.test(d)) return '66' + d.slice(1);
    return d;
  }
  function buildPromptPayEMV(opt={}){
    const pp = normalizePP(opt.id||'');
    const isMobile = /^66\d{9}$/.test(pp);
    const isNat = /^\d{13}$/.test(pp);
    if(!isMobile && !isNat) throw new Error('PromptPay ID ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');

    const payloadFormat='01';
    const poi = opt.amount ? '12':'11';
    const gui='A000000677010111';

    const acct = tlv('00',gui) + (isMobile ? tlv('01',pp) : tlv('02',pp));
    let p='';
    p+=tlv('00',payloadFormat);
    p+=tlv('01',poi);
    p+=tlv('26',acct);
    p+=tlv('52','0000');
    p+=tlv('53','764');
    if(opt.amount){ p+=tlv('54',(+opt.amount).toFixed(2)); }
    p+=tlv('58','TH');
    p+=tlv('59',(opt.name||'FERTILIZER SHOP').slice(0,25)||'NA');
    p+=tlv('60',(opt.city||'BANGKOK').slice(0,15)||'BANGKOK');
    if(opt.billNumber){
      p+=tlv('62', tlv('01', String(opt.billNumber).slice(0,25)));
    }
    const toCRC = p + '6304';
    const crc = crc16ccitt(toCRC);
    return p + tlv('63', crc);
  }
  function renderQR(){
    const canvas = $('#qrCanvas');
    if(!canvas || !window.QRCode) return;
    const payload = buildPromptPayEMV({
      id:PROMPTPAY_ID,
      amount:getCartTotal(),
      name:'FERTILIZER',
      city:'BANGKOK',
      billNumber: $('#orderId')?.textContent || ''
    });
    QRCode.toCanvas(canvas, payload, {width:240, margin:1}, err=>{
      if(err) console.error(err);
    });
  }

  /* ===== Payment ===== */
  function getCartTotal(){ return cart.reduce((s,i)=>s + i.unitPrice*i.qty, 0); }
  function genOrderId(){
    const n = new Date().toISOString().replace(/\D/g,'').slice(0,14);
    const r = Math.floor(Math.random()*1000).toString().padStart(3,'0');
    return `ORD-${n}-${r}`;
  }

  function openPayment(){
    if(!cart.length){
      alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤');
      return;
    }
    $('#orderId').textContent = genOrderId();
    $('#payTotal').textContent = THB.format(getCartTotal());
    $('#ppIdText').textContent = PROMPTPAY_ID;
    selectPayPane('qr');
    renderQR();
    $('#paymentModal').style.display='block';
    $('#paymentModal').setAttribute('aria-hidden','false');
  }
  function closePayment(){
    $('#paymentModal').style.display='none';
    $('#paymentModal').setAttribute('aria-hidden','true');
  }

  $('#payMethods').addEventListener('change', e=>{
    if(e.target.name==='payMethod'){
      selectPayPane(e.target.value);
      if(e.target.value==='qr') renderQR();
    }
  });

  function selectPayPane(v){
    document.querySelectorAll('.radio-card').forEach(el=>{
      const checked = el.querySelector('input')?.value === v;
      el.classList.toggle('active', checked);
      if(el.querySelector('input')) el.querySelector('input').checked = checked;
    });
    ['QR','Slip','COD'].forEach(k=>{
      const p = $('#pane'+k);
      if(p) p.classList.toggle('active', k.toLowerCase()===v);
    });
  }

  function copyText(t){ navigator.clipboard.writeText(t).then(()=>alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß')); }
  function copyAmount(){ navigator.clipboard.writeText(getCartTotal().toFixed(2)).then(()=>alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡πâ‡∏ß')); }

  $('#slipInput').addEventListener('change', e=>{
    const f = e.target.files?.[0];
    const img = $('#slipThumb');
    if(f){
      img.src = URL.createObjectURL(f);
      img.style.display='block';
    }else{
      img.src='';
      img.style.display='none';
    }
  });

  function confirmPayment(){
    const method = document.querySelector('input[name="payMethod"]:checked')?.value;
    const total = getCartTotal();
    const orderId = $('#orderId').textContent || genOrderId();

    if(method === 'qr'){
      if(!$('#qrConfirmed').checked){
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡πä‡∏Å ‚Äú‡∏â‡∏±‡∏ô‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‚Äù');
        return;
      }
      finishOrder({method:'PromptPay QR', total, orderId});
    }else if(method === 'slip'){
      const f = $('#slipInput').files?.[0];
      if(!f){
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô');
        return;
      }
      finishOrder({method:'‡πÇ‡∏≠‡∏ô/‡∏™‡∏•‡∏¥‡∏õ', total, orderId, slipName:f.name});
    }else if(method === 'cod'){
      const name = $('#codName').value.trim();
      const phone = $('#codPhone').value.trim();
      const addr = $('#codAddr').value.trim();
      if(!name || !phone || !addr){
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡∏ä‡∏∑‡πà‡∏≠-‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå-‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
        return;
      }
      finishOrder({method:'‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (COD)', total, orderId, name, phone, addr});
    }
  }

  function snapshotItems(){
    return cart.map(i=>({
      name:i.name,
      type:i.type,
      qty:i.qty,
      unitPrice:i.unitPrice,
      sub:i.qty*i.unitPrice
    }));
  }

  function finishOrder(info){
    const box = $('#paySuccess');
    let lines = [
      `‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞: ${info.method}`,
      `‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠: ${info.orderId}`,
      `‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${THB.format(info.total)}`
    ];
    if(info.slipName) lines.push(`‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏•‡∏¥‡∏õ: ${info.slipName}`);
    box.innerHTML = `<strong>‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</strong><br>${lines.join('<br>')}`;
    box.style.display='block';

    const history = loadHistoryLS();
    const orderDoc = {
      orderId:info.orderId,
      total:info.total,
      method:info.method,
      timestamp:new Date().toISOString(),
      items:snapshotItems()
    };
    if(info.name){
      orderDoc.name = info.name;
      orderDoc.phone = info.phone;
      orderDoc.addr = info.addr;
    }
    history.unshift(orderDoc);
    if(history.length>200) history.length=200;
    saveHistoryLS(history);

    cart=[];
    saveCartLS();
    updateCart();

    lastOrderIdForDelivery = info.orderId;
    openDelivery(info);
  }

  /* ===== Delivery ===== */
  function randomMinutes(max=30){ return Math.floor(Math.random()*max)+1; }

  function openDelivery(info){
    closePayment();
    const mins = randomMinutes(30);
    const etaDate = new Date(Date.now() + mins*60*1000);
    $('#etaMsg').innerHTML =
      `‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚è±Ô∏è ‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ñ‡∏∂‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô <b>${mins} ‡∏ô‡∏≤‡∏ó‡∏µ</b> (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì <b>${DT.format(etaDate)}</b>)`;

    const last = loadLastAddr();
    const seedName  = info?.name  || last.name  || '';
    const seedPhone = info?.phone || last.phone || '';
    const seedAddr  = info?.addr  || last.addr  || '';
    $('#shipName').value = seedName;
    $('#shipPhone').value = seedPhone;
    $('#shipAddr').value = seedAddr;

    $('#deliveryModal').style.display='block';
    $('#deliveryModal').setAttribute('aria-hidden','false');
  }

  function closeDelivery(){
    $('#deliveryModal').style.display='none';
    $('#deliveryModal').setAttribute('aria-hidden','true');
    $('#paySuccess').style.display='none';
    alert('‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠!');
  }

  function saveDelivery(){
    const name = $('#shipName').value.trim();
    const phone = $('#shipPhone').value.trim();
    const addr = $('#shipAddr').value.trim();
    if(!name || !phone || !addr){
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡∏ä‡∏∑‡πà‡∏≠-‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå-‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
      return;
    }
    saveLastAddr({name,phone,addr});

    const hist = loadHistoryLS();
    const idx = hist.findIndex(h=>h.orderId===lastOrderIdForDelivery);
    if(idx>-1){
      hist[idx].name = name;
      hist[idx].phone = phone;
      hist[idx].addr = addr;
      saveHistoryLS(hist);
    }
    closeDelivery();
  }

  /* ===== History ===== */
  function openHistory(){
    const list = $('#historyList');
    const hist = loadHistoryLS();
    if(!hist.length){
      list.innerHTML='<p class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ö‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ</p>';
    }else{
      list.innerHTML = hist.map(h=>{
        const when = DT.format(new Date(h.timestamp));
        const items = h.items.map(it=>`<li>${it.name} (${it.type==='kg'?it.qty+' ‡∏Å‡∏Å.':it.qty+' ‡∏ñ‡∏∏‡∏á'}) ‚Äî ${THB.format(it.sub)}</li>`).join('');
        const addr = (h.name||h.phone||h.addr)
          ? `<div class="muted" style="margin-top:6px">üì¶ ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö: ${h.name||'-'} | ‚òéÔ∏è ${h.phone||'-'}<br>üè† ${h.addr||'-'}</div>`
          : '';
        return `
          <div class="order-card">
            <div class="order-head">
              <div>
                <strong>${h.orderId}</strong><br>
                <span class="muted">${when}</span>
              </div>
              <div style="text-align:right">
                <div><b>${THB.format(h.total)}</b></div>
                <div class="muted">${h.method}</div>
              </div>
            </div>
            <ul class="order-items">${items}</ul>
            ${addr}
          </div>
        `;
      }).join('');
    }
    $('#historyModal').style.display='block';
    $('#historyModal').setAttribute('aria-hidden','false');
  }
  function closeHistory(){
    $('#historyModal').style.display='none';
    $('#historyModal').setAttribute('aria-hidden','true');
  }
  function clearHistory(){
    if(confirm('‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ö‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')){
      saveHistoryLS([]);
      openHistory();
    }
  }

  /* ===== ‡∏ï‡∏•‡∏≤‡∏î‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Firebase + ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°) ===== */
  function renderMarketFromSnapshot(snapshot){
    const list = $('#marketList');
    if(!list) return;

    if(snapshot.empty){
      list.innerHTML =
        '<div class="market-list-empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢‡∏ú‡∏•‡πÑ‡∏°‡πâ<br>‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏à‡∏≤‡∏Å‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</div>';
      return;
    }

    let html = '';
    snapshot.forEach(doc=>{
      const it = doc.data() || {};
      const id = doc.id;

      const tradeType = it.tradeType || 'sell';
      const ownerName = it.ownerName || '';
      const tradeBadgeClass = tradeType === 'buy'
        ? 'trade-badge trade-buy'
        : 'trade-badge trade-sell';
      const tradeLabelText = tradeType === 'buy' ? '‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠' : '‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢';

      const priceText = (it.price && it.unit) ? `‡∏ø${it.price} ${it.unit}` : '';
      const locText   = it.location ? `‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢: ${it.location}` : '';
      const shipText  = it.shipping ? `‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á: ${it.shipping}` : '';
      const phoneText = it.phone
        ? `‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: <a href="tel:${it.phone}">${it.phone}</a>` : '';
      const otherText = it.contact
        ? `‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô: <a href="${it.contact}" target="_blank" rel="noopener noreferrer">${it.contact}</a>` : '';
      const noteText  = it.note ? `‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${it.note}</span>` : '';
      const when = it.createdAt && it.createdAt.toDate ? DT.format(it.createdAt.toDate()) : '';

      const priceNum = parseFloat(it.price || 0);
      const commissionText = (!isNaN(priceNum) && priceNum>0)
        ? `‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô (${(MARKET_COMMISSION_RATE*100).toFixed(0)}% ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à): ‡∏ø${(priceNum*MARKET_COMMISSION_RATE).toFixed(2)} ‡∏ï‡πà‡∏≠ ${it.unit || '‡∏´‡∏ô‡πà‡∏ß‡∏¢'}`
        : '';

      const canDelete = it.ownerId === CLIENT_ID;

      html += `
        <div class="product market-card">
          <span class="${tradeBadgeClass}">${tradeLabelText}</span>
          <h3>${it.fruitName || '-'}</h3>
          <div class="price">${priceText}</div>
          ${ownerName ? `<div class="owner-line muted">‡πÇ‡∏î‡∏¢: ${ownerName}</div>` : ''}
          ${locText   ? `<span class="muted">${locText}</span>`   : ''}
          ${shipText  ? `<span class="muted">${shipText}</span>`  : ''}
          <div class="market-contact muted">
            ${phoneText}<br>
            ${otherText || ''}
          </div>
          ${it.note ? `<span class="muted" style="display:block; margin-top:6px;">${it.note}</span>` : ''}
          ${commissionText ? `<span class="muted" style="display:block; margin-top:4px;">${commissionText}</span>` : ''}
          ${when ? `<span class="muted" style="display:block; margin-top:4px;">‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${when}</span>` : ''}
          ${canDelete ? `
            <div style="margin-top:8px;">
              <button class="remove-btn" onclick="deleteListing('${id}')">‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
              ${priceNum>0 ? `
                <button class="clear-cart" style="margin-left:6px"
                  onclick="reportCommission('${id}', ${priceNum}, '${it.unit || ''}')">
                  ‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à / ‡∏Ñ‡∏¥‡∏î‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°
                </button>` : ''}
            </div>
          ` : ''}
        </div>
      `;
    });
    list.innerHTML = html;
  }

  async function deleteListing(id){
    if(!confirm('‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
    try{
      await marketRef.doc(id).delete();
    }catch(err){
      console.error(err);
      alert('‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î modal ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°
  function openCommissionModal(data){
    const totalSale = data.totalSale;
    const commission = data.commission;
    const fruitName = data.fruitName || '-';
    const listingId = data.listingId || '-';

    const summaryEl = document.getElementById('commissionSummary');
    const ppidEl    = document.getElementById('commissionPPID');
    const canvas    = document.getElementById('commissionQrCanvas');
    const modal     = document.getElementById('commissionModal');

    if(summaryEl){
      summaryEl.innerHTML =
        `‡∏ú‡∏•‡πÑ‡∏°‡πâ: <b>${fruitName}</b><br>` +
        `‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°: <b>${THB.format(totalSale)}</b><br>` +
        `‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞ (${(MARKET_COMMISSION_RATE*100).toFixed(0)}%): ` +
        `<b>${THB.format(commission)}</b>`;
    }
    if(ppidEl){
      ppidEl.textContent = MARKET_COMMISSION_PROMPTPAY_ID;
    }

    if(canvas && window.QRCode){
      const payload = buildPromptPayEMV({
        id: MARKET_COMMISSION_PROMPTPAY_ID,
        amount: commission,
        name: 'FRUIT MARKET',
        city: 'THAILAND',
        billNumber: 'COM-' + listingId
      });
      QRCode.toCanvas(canvas, payload, { width:240, margin:1 }, err=>{
        if(err) console.error(err);
      });
    }

    if(modal){
      modal.style.display = 'block';
      modal.setAttribute('aria-hidden','false');
    }
  }

  function closeCommission(){
    const modal = document.getElementById('commissionModal');
    if(modal){
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
    }
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à + ‡πÄ‡∏õ‡∏¥‡∏î QR
  async function reportCommission(listingId, pricePerUnit, unit){
    const qtyStr = prompt(`‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Å‡∏µ‡πà${unit || '‡∏´‡∏ô‡πà‡∏ß‡∏¢'} ?`);
    if(qtyStr === null) return;
    const qty = parseFloat(qtyStr);
    if(isNaN(qty) || qty <= 0){
      alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      return;
    }

    const totalSale = pricePerUnit * qty;
    const commission = totalSale * MARKET_COMMISSION_RATE;

    try{
      const docSnap = await marketRef.doc(listingId).get();
      const data = docSnap.exists ? docSnap.data() : {};

      const commissionData = {
        listingId,
        ownerId: CLIENT_ID,
        ownerName: data.ownerName || null,
        fruitName: data.fruitName || null,
        qtySold: qty,
        unit: unit || data.unit || null,
        pricePerUnit,
        totalSale,
        commission,
        rate: MARKET_COMMISSION_RATE,
        paid: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      await commissionRef.add(commissionData);

      // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á QR ‡πÉ‡∏´‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°
      openCommissionModal({
        listingId,
        fruitName: commissionData.fruitName,
        totalSale,
        commission
      });

    }catch(err){
      console.error(err);
      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }
  }

  function initMarket(){
    const form = $('#marketForm');
    if(!form || !marketRef) return;

    form.addEventListener('submit', async e=>{
      e.preventDefault();
      const tradeType = $('#tradeType').value || 'sell';
      const ownerName = $('#ownerName').value.trim();
      const fruitName = $('#fruitName').value.trim();
      const price     = $('#price').value.trim();
      const unit      = $('#unit').value.trim();
      const location  = $('#location').value.trim();
      const shipping  = $('#shipping').value.trim();
      const phone     = $('#phone').value.trim();
      const contact   = $('#contact').value.trim();
      const note      = $('#note').value.trim();

      if(!ownerName || !fruitName || !price || !unit || !location || !shipping || !phone){
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ * ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
        return;
      }

      try{
        await marketRef.add({
          tradeType,
          ownerName,
          fruitName,
          price,
          unit,
          location,
          shipping,
          phone,
          contact,
          note,
          ownerId: CLIENT_ID,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        form.reset();
        $('#tradeType').value = 'sell';
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏•‡∏≤‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
      }catch(err){
        console.error(err);
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }
    });

    marketUnsubscribe = marketRef
      .orderBy('createdAt','desc')
      .onSnapshot(renderMarketFromSnapshot, err=>{
        console.error(err);
        const list = $('#marketList');
        if(list) list.innerHTML='<div class="market-list-empty">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏•‡∏≤‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>';
      });
  }

  /* ===== ‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á / ESC ===== */
  window.addEventListener('click',e=>{
    if(e.target===$('#cartModal')) closeCart();
    if(e.target===$('#popup')) closePopup();
    if(e.target===$('#paymentModal')) closePayment();
    if(e.target===$('#historyModal')) closeHistory();
    if(e.target===$('#deliveryModal')) closeDelivery();
    if(e.target===$('#commissionModal')) closeCommission();
  });
  window.addEventListener('keydown',e=>{
    if(e.key==='Escape'){
      if($('#cartModal')?.style.display==='block') closeCart();
      if($('#popup')?.style.display==='block') closePopup();
      if($('#paymentModal')?.style.display==='block') closePayment();
      if($('#historyModal')?.style.display==='block') closeHistory();
      if($('#deliveryModal')?.style.display==='block') closeDelivery();
      if($('#commissionModal')?.style.display==='block') closeCommission();
    }
  });

  /* ===== Init ===== */
  (function init(){
    renderProducts();
    updateCart();
    initMarket();
    setView('shop');   // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏∏‡πã‡∏¢
  })();
</script>
</body>
</html>
